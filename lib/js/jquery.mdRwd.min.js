/* 
 * mdRwd -  A framework for development of Web applications 
 *          partitioned in different communicating devices.
 * v0.1.1 - 2014-04-22
 * http://www.mdRwd.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of mdRwd.
 * 
 * mdRwd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * mdRwd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/

(function(a){a.fn.mdRwd=function(R){var e=a(this);var C="#"+e.attr("id");var o={mdRwd:["newVc","connVc","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var G={ip:"",port:"",debug:false,stateful:false,connVcInterval:500,connVcTimeout:10000,mdRwdOnInit:function(){},mdRwdOnDestroy:function(){},mdRwdOnWindowShow:function(){},mdRwdOnWindowHide:function(){},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aG,aH){},mdRwdOnWarning:function(aG){},mdRwdOnWsOpen:function(aG){},mdRwdOnWsMessage:function(aG){},mdRwdOnWsError:function(aG){},mdRwdOnWsClose:function(aG,aH){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{"1006":"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)","7000":"The virtual channel does not exist","7001":"You are allready conncetd to this virtual channel<br/>Try again","7002":"There is no available virtual channel<br/>Please try again later","7003":"The virtual channel is full<br/>Please try again later","7004":"The virtual channel for current IP is full<br/>Please try again later","7005":"The virtual channel is currently busy<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:Number.POSITIVE_INFINITY}},components:{},layouts:{}};var aB=a.extend(true,{},G,R);var ah={};var t="mdRwd";var aB,c,F,ah,Y,O,V,g,J,t,al,Q,aE,ak;ap();function ap(){N();f();aw();ab();k();s();x();}function N(){aB.connectionTypesArray=["newVc","connVc"];aB.componentsArray=Object.keys(aB.components);aB.devicesArray=Object.keys(aB.devices);aB.layoutsArray=Object.keys(aB.layouts);c={};F={};Y={};O={};V="";g=0;J=5000;al=false;Q=false;aE="";ak="";}function B(){if(!a.isEmptyObject(c)){c.close();}h();}function h(){au();x();if(al){a("link[href='"+Y.css+"']").remove();ay();aD();D();z(function(){aB.mdRwdOnMonoDeviceMode();Y.mdRwdOnMonoDeviceMode();});}else{z();}N();aB.mdRwdOnDestroy();}function x(){e.html(aB.html.connectButton);a(document).off("click",C);a(document).on("click",C,function(){aB.mdRwdOnInit();aq();ao();});}function u(){e.html(aB.html.disconnectButton);a(document).off("click",C);a(document).on("click",C,function(){B();x();});}function y(aG){B();if(aB.debug){a.error("mdRwd => "+aG);}}function k(){a.each(aB.devices,function(aH,aG){if(aG.minWidth&&aG.maxWidth){if(window.screen.width>=aG.minWidth&&window.screen.width<=aG.maxWidth){ah=aG;}}else{y('The device "'+aH+'" must have "minWidh" and "maxWidth" properties');return false;}});}function f(){var aG={id:"",minWidth:0,maxWidth:0};a.each(aB.devices,function(aI,aH){aG.id=aI;aB.devices[aI]=a.extend(true,{},aG,aH);});}function aw(){if(!a.isEmptyObject(aB.components)){var aG={id:"",selector:"",monoDeviceVisible:true};if(aB.stateful){aG.state={};}a.each(aB.components,function(aH,aI){aG.id=aH;aG.monoDeviceVisible=!a(aI.selector).is(":hidden");aB.components[aH]=a.extend(true,{},aG,aI);});}else{y("You must define at least one component");return false;}}function ab(){var aH={};var aG={};a.each(o,function(aK,aJ){aH[aK]="";aG[aK]={};if(aJ.length>0){a.each(aJ,function(aL,aM){aG[aK][aM]=function(){};});}});var aI={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",events:{outgoing:aH,incoming:aG},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aJ,aK){},mdRwdOnWarning:function(aJ){},mdRwdOnWsOpen:function(aJ){},mdRwdOnWsMessage:function(aJ){},mdRwdOnWsError:function(aJ){},mdRwdOnWsClose:function(aJ,aK){}};if(!a.isEmptyObject(aB.layouts)){a.each(aB.layouts,function(aK,aJ){aJ.connectionTypesArray=a.map(aJ.connectionTypes.split(","),a.trim);a.each(aJ.connectionTypesArray,function(aL,aM){if(a.inArray(aM,aB.connectionTypesArray)==-1){y('The connection type "'+aM+'" of the layout "'+aK+'" does not exist (available connection types: "newVc", "connVc")');return false;}});aJ.devicesArray=a.map(aJ.devices.split(","),a.trim);a.each(aJ.devicesArray,function(aL,aM){if(a.inArray(aM,aB.devicesArray)==-1){y('The device "'+aM+'" of the layout "'+aK+'" does not exist (available devices: "'+aB.devicesArray.join('", "')+'")');return false;}});aJ.componentsArray=a.map(aJ.components.split(","),a.trim);a.each(aJ.componentsArray,function(aM,aL){if(a.inArray(aL,aB.componentsArray)==-1){y('The component "'+aL+'" of the layout "'+aK+'" does not exist (available components: "'+aB.componentsArray.join('", "')+'")');return false;}});a.each(aJ.events.outgoing,function(aM,aL){aJ.events.outgoing[aM+"Obj"]={};var aN={};a.each(aL.match(/(?:[^,(]|\([^)]*\))+/g),function(aO,aP){aN=ax(aK,aM,aP);if(aB.stateful){aJ.events.outgoing[aM+"Obj"][aN.event]={};aJ.events.outgoing[aM+"Obj"][aN.event].affectedComponents=aN.affectedComponents;}});});aI.id=aK;aB.layouts[aK]=a.extend(true,{},aI,aJ);});}else{y("You must define at least one layout");return false;}}function az(){a('<link href="'+Y.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");a("body").animate({scrollTop:0},"fast");a.each(aB.components,function(aG,aH){if(a.inArray(aG,Y.componentsArray)>-1){a(aH.selector).show();}else{a(aH.selector).hide();}});}function ay(){a.each(aB.components,function(aG,aH){if(aH.monoDeviceVisible){a(aH.selector).show();}else{a(aH.selector).hide();}});}function s(){var aH="";aH='<div id="mdRwdOverlay"></div>';var aG="";aG+='<div id="mdRwdWindow">';aG+='	<div id="mdRwdWindowHeader">';aG+='	    <div id="mdRwdWindowTitle">'+aB.html.window.header.title+"</div>";aG+='	    <div id="mdRwdWindowClose">'+aB.html.window.header.close+"</div>";aG+="	</div>";aG+='	<div id="mdRwdWindowContent"></div>';aG+='	<img src="'+aB.html.window.content.loadingImgPath+'" style="display:none;"/>';aG+="</div>";a("body").append(aH);a("body").append(aG);}function aq(){if(a("#mdRwdWindow").is(":hidden")){a("#mdRwdWindow").slideDown("fast");a("#mdRwdOverlay").fadeIn("fast").promise().done(function(){aB.mdRwdOnWindowShow();a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).on("click","#mdRwdWindowClose, #mdRwdOverlay",function(){B();});});}}function z(aG){if(!a("#mdRwdOverlay").is(":hidden")){a("#mdRwdOverlay").fadeOut("fast");a("#mdRwdWindow").slideUp("fast").promise().done(function(){aB.mdRwdOnWindowHide();a("#mdRwdVcId").html("");a(".mdRwdWarningMessage").html("");if(aG){aG();}});}else{if(aG){aG();}}}function ao(){var aH=[];a.each(aB.layouts,function(aJ,aI){if(a.inArray(ah.id,aI.devicesArray)>-1){aH.push(aJ);}});var aG="";if(aH.length>1){aG+='<div id="mdRwdLayoutsCell">';aG+='	    <div id="mdRwdLayoutsBox">';aG+='             <div class="mdRwdLoadingBox">';aG+='                 <img src="'+aB.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aG+="             </div>";aG+='             <div id="mdRwdLayoutChoice">';aG+='                 <div id="mdRwdLayoutLabel">'+aB.html.window.content.layoutsLabel+"</div>";aG+='                 <div id="mdRwdLayouts">';a.each(aH,function(aJ,aI){var aK=aB.layouts[aI];aG+='             <div class="mdRwdLayout mdRwdButton" layoutId="'+aI+'">';aG+='                 <div class="mdRwdLayoutName">'+aK.html.name+"</div>";aG+='                 <div class="mdRwdLayoutDescription">'+aK.html.description+"</div>";aG+="             </div>";});aG+="                 </div>";aG+="		</div>";aG+="	    </div>";aG+="</div>";a("#mdRwdWindowContent").html(aG);a(document).off("click",".mdRwdLayout");a(document).on("click",".mdRwdLayout",function(){Y=aB.layouts[a(this).attr("layoutId")];ac();});}else{if(aH.length==1){aG+='<div id="mdRwdLayoutsCell">';aG+='	    <div id="mdRwdLayoutsBox">';aG+='             <div class="mdRwdLoadingBox">';aG+='                 <img src="'+aB.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aG+="             </div>";aG+='             <div id="mdRwdLayoutChoice">';aG+="             </div>";aG+="         </div>";aG+="</div>";a("#mdRwdWindowContent").html(aG);Y=aB.layouts[aH[0]];ac();}else{y('The "'+ah.id+'" device has no associated layouts');return false;}}}function w(aG){return a.trim(aG)+"."+t;}function ax(aH,aJ,aK){var aG=aK.match(/\((.*?)\)/g);var aM=[];var aL=a.trim(aK);var aI={};if(aG){aM=a.trim(aK.match(/\((.*?)\)/g)[0]);aM=aM.slice(1,-1);aL=a.trim(aK.replace("("+aM+")",""));aM=a.map(aM.split(","),a.trim);a.each(aM,function(aO,aN){if(a.inArray(aN,aB.componentsArray)==-1){y('The affected component "'+aN+'" by the outgoing event "'+aL+'" of the layout "'+aH+'" does not exist');return false;}});}if(aJ!="custom"&&a.inArray(aL,o[aJ])==-1){y('The outgoing event "'+aL+'" of the layout "'+aH+'" does not exist in the default "'+aJ+'" events');return false;}aI.event=aL;aI.affectedComponents=aM;return aI;}function l(){E();ai();T();an();}function aa(){q();H();P();av();}function au(){a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).off("click",".mdRwdLayout");a(document).off("keydown","#mdRwdConnectVcId");a(document).off("click","#mdRwdConnectVcButton");a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");}function aD(){b();m();i();n();}function D(){W();ar();aF();ae();}function aA(aG){F={cmd:"triggerVcEvent",vcId:V,event:aG,client:{layout:{id:Y.id}}};if(aB.stateful){F.client.layout.components=Y.componentsArray;}S(F);}function E(){var aG=Y.events.outgoing.keyboard;if(aG){if(aG=="all"){aG=a.map(o.keyboard.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.keyboardObj),w).join(" ");}a(document).on(aG,function(aI){if(!aI.namespace||aI.namespace!=t){var aH={type:aI.type,eventData:{timeStamp:aI.timeStamp,altKey:aI.altKey,shiftKey:aI.shiftKey,ctrlKey:aI.ctrlKey,metaKey:aI.metaKey,charCode:aI.charCode,keyCode:aI.keyCode}};if(aB.stateful){aH.affectedComponents=Y.events.outgoing.keyboardObj[aI.type].lenght>0?Y.events.outgoing.keyboardObj[aI.type].join(", "):"";}aA(aH);}});}}function b(){var aG=Y.events.outgoing.keyboard;if(aG){if(aG=="all"){aG=a.map(o.keyboard.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.keyboardObj),w).join(" ");}a(document).off(aG);}}function q(){if(Y.events.incoming.keyboard){a.each(Y.events.incoming.keyboard,function(aG,aH){a(document).on(w(aG),aH);});}}function W(){if(Y&&Y.events&&Y.events.incoming&&Y.events.incoming.keyboard){a.each(Y.events.incoming.keyboard,function(aG,aH){a(document).off(w(aG));});}}function ai(){var aG=Y.events.outgoing.mouse;if(aG){if(aG=="all"){aG=a.map(o.mouse.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.mouseObj),w).join(" ");}a(document).on(aG,function(aH){if(!aH.namespace||aH.namespace!=t){var aI={type:aH.type,eventData:{timeStamp:aH.timeStamp,altKey:aH.altKey,shiftKey:aH.shiftKey,ctrlKey:aH.ctrlKey,metaKey:aH.metaKey,button:aH.button,center:{pageX:aH.pageX,pageY:aH.pageY},target:aH.target.id}};if(aB.stateful){aI.affectedComponents=Y.events.outgoing.mouseObj[aH.type].affectedComponents.length>0?Y.events.outgoing.mouseObj[aH.type].affectedComponents:[];}aA(aI);}});}}function m(){var aG=Y.events.outgoing.mouse;if(aG){if(aG=="all"){aG=a.map(o.mouse.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.mouseObj),w).join(" ");}a(document).off(aG);}}function H(){if(Y.events.incoming.mouse){a.each(Y.events.incoming.mouse,function(aH,aG){a(document).on(w(aH),aG);});}}function ar(){if(Y&&Y.events&&Y.events.incoming&&Y.events.incoming.mouse){a.each(Y.events.incoming.mouse,function(aH,aG){a(document).off(w(aH));});}}function T(){var aG=Y.events.outgoing.touch;if(aG){if(aG=="all"){aG=a.map(o.touch.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.touchObj),w).join(" ");}a(document).hammer({prevent_default:true}).on(aG,function(aJ){if(!aJ.namespace||aJ.namespace!=t){var aK=[];var aH={};var aI={};if(aJ.gesture){if(aJ.gesture.startEvent.touches){a.each(aJ.gesture.startEvent.touches,function(aL,aM){aK.push({type:aM.type,eventData:{center:{pageX:aM.pageX,pageY:aM.pageY},parentOffsetX:aM.offsetX,parentOffsetY:aM.offsetY,target:aM.target.id}});});}aI={type:aJ.type,eventData:{timeStamp:aJ.gesture.startEvent.timeStamp,target:aJ.gesture.startEvent.target.id,center:aJ.gesture.startEvent.center,pointerType:aJ.gesture.startEvent.pointerType,eventType:aJ.gesture.startEvent.eventType,srcEventType:aJ.gesture.startEvent.srcEvent.type,touches:aK}};if(aJ.gesture.touches){aK=[];a.each(aJ.gesture.touches,function(aL,aM){aK.push({type:aM.type,eventData:{center:{pageX:aM.pageX,pageY:aM.pageY},parentOffsetX:aM.offsetX,parentOffsetY:aM.offsetY,target:aM.target.id}});});}aH={type:aJ.type,eventData:{timeStamp:aJ.gesture.timeStamp,screenDim:{height:a(window).height(),width:a(window).width()},target:aJ.gesture.target.id,center:aJ.gesture.center,pointerType:aJ.gesture.pointerType,deltaTime:aJ.gesture.deltaTime,deltaX:aJ.gesture.deltaX,deltaY:aJ.gesture.deltaY,velocityX:aJ.gesture.velocityX,velocityY:aJ.gesture.velocityY,angle:aJ.gesture.angle,direction:aJ.gesture.direction,distance:aJ.gesture.distance,scale:aJ.gesture.scale,rotation:aJ.gesture.rotation,eventStatus:aJ.gesture.eventType,srcEventType:aJ.gesture.srcEvent.type,startEvent:aI,touches:aK}};if(aB.stateful){aH.affectedComponents=Y.events.outgoing.touchObj[aJ.type].affectedComponents.length>0?Y.events.outgoing.touchObj[aJ.type].affectedComponents:[];}}aA(aH);}});}}function i(){var aG=Y.events.outgoing.touch;if(aG){if(aG=="all"){aG=a.map(o.touch.join(" "),w);}else{aG=a.map(Object.keys(Y.events.outgoing.touchObj),w).join(" ");}a(document).hammer().off(aG);}}function P(){if(Y.events.incoming.touch){a.each(Y.events.incoming.touch,function(aH,aG){a(document).on(w(aH),aG);});}}function aF(){if(Y&&Y.events&&Y.events.incoming&&Y.events.incoming.touch){a.each(Y.events.incoming.touch,function(aH,aG){a(document).off(w(aH));});}}function an(){var aG=Y.events.outgoing.custom;if(aG){aG=a.map(Object.keys(Y.events.outgoing.customObj),w).join(" ");a(document).on(aG,function(aI){if(!aI.namespace||aI.namespace!=t){var aH={type:aI.type,eventData:aI.eventData?aI.eventData:{}};if(aB.stateful){aH.affectedComponents=Y.events.outgoing.customObj[aI.type].affectedComponents.length>0?Y.events.outgoing.customObj[aI.type].affectedComponents:[];}aA(aH);}});}}function n(){var aG=Y.events.outgoing.custom;if(aG){aG=a.map(Object.keys(Y.events.outgoing.customObj),w).join(" ");a(document).off(aG);}}function av(){if(Y.events.incoming.custom){a.each(Y.events.incoming.custom,function(aG,aH){a(document).on(w(aG),aH);});}}function ae(){if(Y&&Y.events&&Y.events.incoming&&Y.events.incoming.custom){a.each(Y.events.incoming.custom,function(aG,aH){a(document).off(w(aG));});}}function ac(){if(window.WebSocket){if(a.isEmptyObject(c)){c=new WebSocket("ws://"+aB.ip+":"+aB.port+"/");c.onopen=af;c.onmessage=aC;c.onerror=M;c.onclose=p;a("#mdRwdLayoutsBox .mdRwdLoadingBox").show();a("#mdRwdLayoutChoice").hide();}else{y("Waiting for WebSocket connection");return false;}}else{y("The current browser does not support WebSockets");return false;}}function S(aG){aG=JSON.stringify(aG);if(c.readyState===1){c.send(aG);}else{y("WebSocket connection has been lost");return false;}}function af(aG){r();aB.mdRwdOnWsOpen(aG);Y.mdRwdOnWsOpen(aG);}function M(aG){aB.mdRwdOnWsError(aG);if(!a.isEmptyObject(Y)){Y.mdRwdOnWsError(aG);}}function p(aG){if(aG.code===1006){a("#mdRwdLayoutsBox .mdRwdLoadingBox").hide();a("#mdRwdLayoutChoice").html('<div class="mdRwdWarningMessage">'+aB.html.window.content.warningMessages[aG.code]+"</div>");a("#mdRwdLayoutChoice").show();}aB.mdRwdOnWsClose(aG.code,aG);if(!a.isEmptyObject(Y)){console.log(Y);Y.mdRwdOnWsClose(aG.code,aG);}}function aC(aI){var aG=JSON.parse(aI.data);var aH={namespace:t,timeStamp:aG.timeStamp,type:aG.cmd=="triggerVcEvent"?aG.event.type:aG.cmd,eventData:aG.cmd=="triggerVcEvent"?aG.event.eventData:null,client:aG.client,vcId:aG.vcId};switch(aG.cmd){case"newVc":ad(aH,aG);break;case"connVc":U(aH,aG);break;case"triggerVcEvent":A(aH,aG);break;case"rmVcClient":at(aH,aG);break;case"rmVc":Z(aH,aG);break;default:break;}aB.mdRwdOnWsMessage(aI,aG);Y.mdRwdOnWsMessage(aI,aG);}function r(){var aG="";aG+=d();aG+=v();a("#mdRwdWindowContent").html(aG);if(a("#mdRwdConnectVcId").length){a("#mdRwdConnectVcId").focus();}}function d(){var aG="";if(a.inArray("newVc",Y.connectionTypesArray)>-1){I();aG+='<div id="mdRwdVcCell" '+(Y.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aG+='	<div id="mdRwdVcBox">';aG+='	    <div id="mdRwdVcLabel">'+aB.html.window.content.vcLabel+"</div>";aG+='         <div class="mdRwdLoadingBox">';aG+='             <img src="'+aB.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aG+="         </div>";aG+='	    <div id="mdRwdVcId"></div>';aG+="	</div>";aG+="</div>";}return aG;}function v(){var aG="";if(a.inArray("connVc",Y.connectionTypesArray)>-1){aG+='<div id="mdRwdConnectVcCell" '+(Y.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aG+='	<div id="mdRwdConnectVcBox">';aG+='	    <div id="mdRwdConnectVcLabel">'+aB.html.window.content.connectVcLabel+"</div>";aG+='         <div class="mdRwdLoadingBox">';aG+='             <img src="'+aB.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aG+="         </div>";aG+='	    <div id="mdRwdConnectVc"><input type="text" pattern="[0-9]*" id="mdRwdConnectVcId"/><button id="mdRwdConnectVcButton">'+aB.html.window.content.connectVcButton+"</button></div>";aG+="	</div>";aG+="</div>";a(document).off("keydown","#mdRwdConnectVcId");a(document).on("keydown","#mdRwdConnectVcId",function(aH){if(aH.keyCode==13){a("#mdRwdConnectVcButton").trigger("click");}});a(document).off("click","#mdRwdConnectVcButton");a(document).on("click","#mdRwdConnectVcButton",function(){V=a("#mdRwdConnectVcId").val();L(false);});}return aG;}function I(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();F={cmd:"newVc",vcId:"",client:{layout:{id:Y.id}}};if(aB.stateful){F.initComponents={};a.each(aB.components,function(aG,aH){F.initComponents[aG]={};F.initComponents[aG].id=aH.id;F.initComponents[aG].state=aH.state;});F.client.layout.components=aB.componentsArray;}S(F);}function ad(aI,aH){a("#mdRwdVcBox .mdRwdLoadingBox").hide();a("#mdRwdVcId").show();V=aH.vcId;if(g==0&&aH.client.isMe){g=aH.client.id;}if(aH.statusCode!=J){aB.mdRwdOnWarning(aH.statusCode);Y.mdRwdOnWarning(aH.statusCode);var aG="";aG+='<div class="mdRwdWarning">';aG+=' <div class="mdRwdWarningMessage">'+aB.html.window.content.warningMessages[aH.statusCode]+"</div>";aG+=' <div class="mdRwdWarningBackButton">'+aB.html.window.content.warningBackButton+"</div>";aG+="</div>";a("#mdRwdVcId").html(aG);a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdVcBox .mdRwdWarningBackButton",function(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();var aJ="";aJ+=d();a("#mdRwdVcCell").replaceWith(aJ);});}else{a("#mdRwdVcId").html(V);Y.events.incoming.mdRwd.newVc(aI,aH);}}function L(aG){a("#mdRwdConnectVc").hide();a("#mdRwdConnectVcBox .mdRwdLoadingBox").show();F={cmd:"connVc",vcId:V,changeLayout:aG,client:{layout:{id:Y.id}}};if(aB.stateful){F.client.layout.components=Y.componentsArray;}S(F);}function U(aI,aH){if(g==0&&aH.client.isMe){g=aH.client.id;}if(aH.statusCode!=J){if(aH.lock){aE=Date.now();if(!Q){Q=true;ak=aE;}if(aE-ak>aB.connVcTimeout){aB.mdRwdOnWarning(aH.statusCode);Y.mdRwdOnWarning(aH.statusCode);Q=false;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aG="";aG+='<div class="mdRwdWarning">';aG+=' <div class="mdRwdWarningMessage">'+aB.html.window.content.warningMessages[aH.statusCode]+"</div>";aG+=' <div class="mdRwdWarningBackButton">'+aB.html.window.content.warningBackButton+"</div>";aG+="</div>";a("#mdRwdConnectVc").html(aG);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aJ="";aJ+=v();a("#mdRwdConnectVcCell").replaceWith(aJ);a("#mdRwdConnectVcId").focus();});}else{setTimeout(function(){L(false);},aB.connVcInterval);}}else{aB.mdRwdOnWarning(aH.statusCode);Y.mdRwdOnWarning(aH.statusCode);a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aG="";aG+='<div class="mdRwdWarning">';aG+=' <div class="mdRwdWarningMessage">'+aB.html.window.content.warningMessages[aH.statusCode]+"</div>";aG+=' <div class="mdRwdWarningBackButton">'+aB.html.window.content.warningBackButton+"</div>";aG+="</div>";a("#mdRwdConnectVc").html(aG);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aJ="";aJ+=v();a("#mdRwdConnectVcCell").replaceWith(aJ);a("#mdRwdConnectVcId").focus();});}}else{if(!al){al=true;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();if(aB.stateful){if(aH.client.isMe){j(aH.componentsFromServer);}}z(function(){aB.mdRwdOnMultiDeviceMode();Y.mdRwdOnMultiDeviceMode();});e.focus();az();l();aa();u();}Y.events.incoming.mdRwd.connVc(aI,aH);}}function A(aH,aG){K(aH);Y.events.incoming.mdRwd.triggerVcEvent(aH,aG);}function at(aH,aG){Y.events.incoming.mdRwd.rmVcClient(aH,aG);}function Z(aH,aG){Y.events.incoming.mdRwd.rmVc(aH,aG);}function K(aG){a(document).trigger(aG);}function j(aG){a.each(aG,function(aH,aI){ag(aH,aI.state,false);});}function ag(aG,aH,aI){if(aB.components[aG]){aB.components[aG].state=aH;aI=typeof aI!=="undefined"?aI:false;if(aI){aj(aG);}}else{y('The component "'+aG+'" does not exist');return false;}}function aj(aH){var aG={};aG.id=aB.components[aH].id;aG.state=aB.components[aH].state;F={cmd:"setVcCompState",vcId:V,componentState:aG,client:{layout:{id:Y.id,components:Y.componentsArray}}};S(F);}function am(aG){if(aB.components[aG]){return aB.components[aG].state;}else{y('The component "'+aG+'" does not exist');return false;}}function X(aG){if(aB.layouts[aG]){if(aG!=Y.id){if(a.inArray(ah.id,aB.layouts[aG].devicesArray)>-1){aD();D();O={};aB.mdRwdOnChangeLayout(Y.id,aG);Y.mdRwdOnChangeLayout(Y.id,aG);Y=aB.layouts[aG];al=false;Q=false;L(true);}else{y('The layout "'+aG+'"  is not associated with the current "'+ah.id+'" device');return false;}}else{y('The layout "'+aG+'" is the current layout');return false;}}else{y('The layout "'+aG+'" does not exist');return false;}}if(aB.stateful){return{triggerVcEvent:K,setVcCompState:ag,getVcCompState:am,changeLayout:X};}else{return{triggerVcEvent:K,changeLayout:X};}};})(jQuery);