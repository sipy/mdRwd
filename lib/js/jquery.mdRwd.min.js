/* 
 * mdRwd -  A framework for development of Web applications 
 *          partitioned in different communicating devices.
 * http://www.mdRwd.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of mdRwd.
 * 
 * mdRwd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * mdRwd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/

(function(a){a.fn.mdRwd=function(Y){var f=a(this);var G="#"+f.attr("id");var r={mdRwd:["newVc","connVc","changeLayout","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var K={ip:"",port:"",debug:false,stateful:false,connVcInterval:500,connVcTimeout:10000,mdRwdOnInit:function(){},mdRwdOnDestroy:function(){},mdRwdOnWindowShow:function(){},mdRwdOnWindowHide:function(){},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnWarning:function(aQ){},mdRwdOnWsOpen:function(aQ){},mdRwdOnWsMessage:function(aQ){},mdRwdOnWsError:function(aQ){},mdRwdOnWsClose:function(aQ,aR){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"../../lib/img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{"1006":"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)","7000":"The virtual channel does not exist","7001":"You are allready conncetd to this virtual channel<br/>Try again","7002":"There is no available virtual channel<br/>Please try again later","7003":"The virtual channel is full<br/>Please try again later","7004":"The virtual channel for current IP is full<br/>Please try again later","7005":"The virtual channel is currently busy<br/>Please try again later","7006":"The virtual channel for current layout is full<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:4096}},components:{},layouts:{}};var aL=a.extend(true,{},K,Y);var aq={};var x="mdRwd";var aL,d,J,aq,ag,V,ac,h,O,ah,aG,av,P,x,X,aO,au;az();function az(){U();g();aF();ak();m();w();B()}function U(){aL.connectionTypesArray=["newVc","connVc"];aL.componentsArray=Object.keys(aL.components);aL.devicesArray=Object.keys(aL.devices);aL.layoutsArray=Object.keys(aL.layouts);d={};J={};ag={};V={};ac=null;h=null;O="monoDevice";ah="multiDevice";aG=O;av=false;P=5000;av=false;X=false;aO=null;au=null}function F(){if(!a.isEmptyObject(d)){d.close()}j()}function j(){B();aD();B();if(av){a("link[href='"+ag.css+"']").remove();aI();aN();H();D(function(){aL.mdRwdOnMonoDeviceMode();ag.mdRwdOnMonoDeviceMode()})}else{D()}U();aL.mdRwdOnDestroy()}function B(){f.html(aL.html.connectButton);a(document).off("click",G);a(document).on("click",G,function(){aL.mdRwdOnInit();aA();ay();return false})}function y(){f.html(aL.html.disconnectButton);a(document).off("click",G);a(document).on("click",G,function(){F()})}function C(aQ){F();if(aL.debug){a.error("mdRwd => "+aQ)}}function m(){a.each(aL.devices,function(aR,aQ){if(aQ.minWidth&&aQ.maxWidth){if(window.screen.width>=aQ.minWidth&&window.screen.width<=aQ.maxWidth){aq=aQ;aq.screenWidth=window.screen.width;aq.screenHeight=window.screen.height}}else{C('The device "'+aR+'" must have "minWidh" and "maxWidth" properties');return false}})}function g(){var aQ={id:"",minWidth:0,maxWidth:0};a.each(aL.devices,function(aS,aR){aQ.id=aS;aL.devices[aS]=a.extend(true,{},aQ,aR)})}function aF(){if(!a.isEmptyObject(aL.components)){var aQ={id:"",selector:"",monoDeviceVisible:true};if(aL.stateful){aQ.state={}}a.each(aL.components,function(aR,aS){aQ.id=aR;aQ.monoDeviceVisible=!a(aS.selector).is(":hidden");aL.components[aR]=a.extend(true,{},aQ,aS)})}else{C("You must define at least one component");return false}}function ak(){var aR={};var aQ={};aQ.mdRwd={};a.each(r.mdRwd,function(aT,aU){aQ.mdRwd[aU]=function(){}});var aS={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",maxInstances:-1,hidden:false,events:{outgoing:aR,incoming:aQ},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnWarning:function(aT){},mdRwdOnWsOpen:function(aT){},mdRwdOnWsMessage:function(aT){},mdRwdOnWsError:function(aT){},mdRwdOnWsClose:function(aT,aU){}};if(!a.isEmptyObject(aL.layouts)){a.each(aL.layouts,function(aU,aT){aS.id=aU;aL.layouts[aU]=a.extend(true,{},aS,aT)});a.each(aL.layouts,function(aU,aT){aT.connectionTypesArray=a.map(aT.connectionTypes.split(","),a.trim);if(a.trim(aT.connectionTypesArray)!=""){a.each(aT.connectionTypesArray,function(aV,aW){if(a.inArray(aW,aL.connectionTypesArray)==-1){C('The connection type "'+aW+'" of the layout "'+aU+'" does not exist (available connection types: "newVc", "connVc")');return false}})}else{C('You must list at least one connection type for the layout "'+aU+'"');return false}aT.devicesArray=a.map(aT.devices.split(","),a.trim);if(a.trim(aT.devices)!=""){a.each(aT.devicesArray,function(aV,aW){if(a.inArray(aW,aL.devicesArray)==-1){C('The device "'+aW+'" of the layout "'+aU+'" does not exist (available devices: "'+aL.devicesArray.join('", "')+'")');return false}})}else{C('You must list at least one device for the layout "'+aU+'"');return false}aT.componentsArray=a.map(aT.components.split(","),a.trim);if(a.trim(aT.componentsArray)!=""){a.each(aT.componentsArray,function(aW,aV){if(a.inArray(aV,aL.componentsArray)==-1){C('The component "'+aV+'" of the layout "'+aU+'" does not exist (available components: "'+aL.componentsArray.join('", "')+'")');return false}})}else{C('You must list at least one component for the layout "'+aU+'"');return false}a.each(aT.events.outgoing,function(aV,aW){aT.events.outgoing[aV+"Obj"]={};var aX={};if(aW.match(/(?:[^,(]|\([^)]*\))+/g)!=null){a.each(aW.match(/(?:[^,(]|\([^)]*\))+/g),function(aY,aZ){aX=aH(aU,aV,aZ);aT.events.outgoing[aV+"Obj"][aX.event]={};if(aL.stateful){aT.events.outgoing[aV+"Obj"][aX.event].affectedComponents=aX.affectedComponents}})}else{C('You must list at least one outgoing event of type "'+aV+'" for the layout "'+aU+'"');return false}})})}else{C("You must define at least one layout");return false}}function aJ(){a('<link href="'+ag.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");a("body").animate({scrollTop:0},"fast");a.each(aL.components,function(aQ,aR){if(a.inArray(aQ,ag.componentsArray)>-1){a(aR.selector).show()}else{a(aR.selector).hide()}})}function aI(){a.each(aL.components,function(aQ,aR){if(aR.monoDeviceVisible){a(aR.selector).show()}else{a(aR.selector).hide()}})}function w(){var aR="";aR='<div id="mdRwdOverlay"></div>';var aQ="";aQ+='<div id="mdRwdWindow">';aQ+='	<div id="mdRwdWindowHeader">';aQ+='	    <div id="mdRwdWindowTitle">'+aL.html.window.header.title+"</div>";aQ+='	    <div id="mdRwdWindowClose">'+aL.html.window.header.close+"</div>";aQ+="	</div>";aQ+='	<div id="mdRwdWindowContent"></div>';aQ+='	<img src="'+aL.html.window.content.loadingImgPath+'" style="display:none;"/>';aQ+="</div>";a("body").append(aR);a("body").append(aQ)}function aA(){if(a("#mdRwdWindow").is(":hidden")){a("#mdRwdWindow").slideDown("fast");a("#mdRwdOverlay").fadeIn("fast").promise().done(function(){aL.mdRwdOnWindowShow();a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).on("click","#mdRwdWindowClose, #mdRwdOverlay",function(){F()})})}}function D(aQ){if(!a("#mdRwdOverlay").is(":hidden")){a("#mdRwdOverlay").fadeOut("fast");a("#mdRwdWindow").slideUp("fast").promise().done(function(){aL.mdRwdOnWindowHide();a("#mdRwdVcId").html("");a(".mdRwdWarningMessage").html("");if(aQ){aQ()}})}else{if(aQ){aQ()}}}function ay(){var aR=[];a.each(aL.layouts,function(aT,aS){if(a.inArray(aq.id,aS.devicesArray)>-1&&!aS.hidden){aR.push(aT)}});var aQ="";if(aR.length>1){aQ+='<div id="mdRwdLayoutsCell">';aQ+='	    <div id="mdRwdLayoutsBox">';aQ+='             <div class="mdRwdLoadingBox">';aQ+='                 <img src="'+aL.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aQ+="             </div>";aQ+='             <div id="mdRwdLayoutChoice">';aQ+='                 <div id="mdRwdLayoutLabel">'+aL.html.window.content.layoutsLabel+"</div>";aQ+='                 <div id="mdRwdLayouts">';a.each(aR,function(aT,aS){var aU=aL.layouts[aS];aQ+='             <div class="mdRwdLayout mdRwdButton" layoutId="'+aS+'">';aQ+='                 <div class="mdRwdLayoutName">'+aU.html.name+"</div>";aQ+='                 <div class="mdRwdLayoutDescription">'+aU.html.description+"</div>";aQ+="             </div>"});aQ+="                 </div>";aQ+="		</div>";aQ+="	    </div>";aQ+="</div>";a("#mdRwdWindowContent").html(aQ);a(document).off("click",".mdRwdLayout");a(document).on("click",".mdRwdLayout",function(){ag=aL.layouts[a(this).attr("layoutId")];al()})}else{if(aR.length==1){aQ+='<div id="mdRwdLayoutsCell">';aQ+='	    <div id="mdRwdLayoutsBox">';aQ+='             <div class="mdRwdLoadingBox">';aQ+='                 <img src="'+aL.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aQ+="             </div>";aQ+='             <div id="mdRwdLayoutChoice">';aQ+="             </div>";aQ+="         </div>";aQ+="</div>";a("#mdRwdWindowContent").html(aQ);ag=aL.layouts[aR[0]];al()}else{C('The "'+aq.id+'" device has no associated visibile layouts');return false}}}function A(aQ){return a.trim(aQ)+"."+x}function aH(aR,aT,aU){var aQ=aU.match(/\((.*?)\)/g);var aW=[];var aV=a.trim(aU);var aS={};if(aQ){aW=a.trim(aU.match(/\((.*?)\)/g)[0]);aW=aW.slice(1,-1);aV=a.trim(aU.replace("("+aW+")",""));aW=a.map(aW.split(","),a.trim);a.each(aW,function(aY,aX){if(a.inArray(aX,aL.componentsArray)==-1){C('The affected component "'+aX+'" by the outgoing event "'+aV+'" of the layout "'+aR+'" does not exist');return false}})}if(aT!="custom"&&a.inArray(aV,r[aT])==-1){C('The outgoing event "'+aV+'" of the layout "'+aR+'" does not exist in the default "'+aT+'" events');return false}aS.event=aV;aS.affectedComponents=aW;return aS}function n(){I();ar();aa();ax()}function aj(){u();L();W();aE()}function aD(){a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).off("click",".mdRwdLayout");a(document).off("keydown","#mdRwdConnectVcId");a(document).off("click","#mdRwdConnectVcButton");a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton")}function aN(){b();o();k();p()}function H(){ad();aB();aP();an()}function aK(aQ){J={cmd:"triggerVcEvent",vcId:ac,event:aQ,client:{device:aq,layout:{id:ag.id}}};if(aL.stateful){J.client.layout.components=ag.componentsArray}Z(J)}function I(){var aQ=ag.events.outgoing.keyboard;if(aQ){if(aQ=="all"){aQ=a.map(r.keyboard.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.keyboardObj),A).join(" ")}a(document).on(aQ,function(aS){if(!aS.namespace||aS.namespace!=x){var aR={type:aS.type,eventData:{timeStamp:aS.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},altKey:aS.altKey,shiftKey:aS.shiftKey,ctrlKey:aS.ctrlKey,metaKey:aS.metaKey,charCode:aS.charCode,keyCode:aS.keyCode}};if(aL.stateful){aR.affectedComponents=ag.events.outgoing.keyboardObj[aS.type].lenght>0?ag.events.outgoing.keyboardObj[aS.type].join(", "):""}aK(aR)}})}}function b(){var aQ=ag.events.outgoing.keyboard;if(aQ){if(aQ=="all"){aQ=a.map(r.keyboard.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.keyboardObj),A).join(" ")}a(document).off(aQ)}}function u(){if(ag.events.incoming.keyboard){a.each(ag.events.incoming.keyboard,function(aQ,aR){a(document).on(A(aQ),aR)})}}function ad(){if(ag&&ag.events&&ag.events.incoming&&ag.events.incoming.keyboard){a.each(ag.events.incoming.keyboard,function(aQ,aR){a(document).off(A(aQ))})}}function ar(){var aQ=ag.events.outgoing.mouse;if(aQ){if(aQ=="all"){aQ=a.map(r.mouse.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.mouseObj),A).join(" ")}a(document).on(aQ,function(aR){if(!aR.namespace||aR.namespace!=x){var aS={type:aR.type,eventData:{timeStamp:aR.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},altKey:aR.altKey,shiftKey:aR.shiftKey,ctrlKey:aR.ctrlKey,metaKey:aR.metaKey,button:aR.button,center:{pageX:aR.pageX,pageY:aR.pageY},target:{id:aR.target.id,classes:aR.target.className.split(" ")}}};if(aL.stateful){aS.affectedComponents=ag.events.outgoing.mouseObj[aR.type].affectedComponents.length>0?ag.events.outgoing.mouseObj[aR.type].affectedComponents:[]}aK(aS)}})}}function o(){var aQ=ag.events.outgoing.mouse;if(aQ){if(aQ=="all"){aQ=a.map(r.mouse.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.mouseObj),A).join(" ")}a(document).off(aQ)}}function L(){if(ag.events.incoming.mouse){a.each(ag.events.incoming.mouse,function(aR,aQ){a(document).on(A(aR),aQ)})}}function aB(){if(ag&&ag.events&&ag.events.incoming&&ag.events.incoming.mouse){a.each(ag.events.incoming.mouse,function(aR,aQ){a(document).off(A(aR))})}}function aa(){var aQ=ag.events.outgoing.touch;if(aQ){if(aQ=="all"){aQ=a.map(r.touch.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.touchObj),A).join(" ")}a(document).hammer({prevent_default:true}).on(aQ,function(aT){if(!aT.namespace||aT.namespace!=x){var aU=[];var aR={};var aS={};if(aT.gesture){if(aT.gesture.startEvent.touches){a.each(aT.gesture.startEvent.touches,function(aV,aW){aU.push({type:aW.type,eventData:{center:{pageX:aW.pageX,pageY:aW.pageY},parentOffsetX:aW.offsetX,parentOffsetY:aW.offsetY,target:{id:aW.target.id,classes:aW.target.className.split(" ")}}})})}aS={type:aT.type,eventData:{timeStamp:aT.gesture.startEvent.timeStamp,target:{id:aT.gesture.target.id,classes:aT.gesture.target.className.split(" ")},center:aT.gesture.startEvent.center,pointerType:aT.gesture.startEvent.pointerType,eventType:aT.gesture.startEvent.eventType,srcEventType:aT.gesture.startEvent.srcEvent.type,touches:aU}};if(aT.gesture.touches){aU=[];a.each(aT.gesture.touches,function(aV,aW){aU.push({type:aW.type,eventData:{center:{pageX:aW.pageX,pageY:aW.pageY},parentOffsetX:aW.offsetX,parentOffsetY:aW.offsetY,target:{id:aW.target.id,classes:aW.target.className.split(" ")}}})})}aR={type:aT.type,eventData:{timeStamp:aT.gesture.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},target:{id:aT.gesture.target.id,classes:aT.gesture.target.className.split(" ")},center:aT.gesture.center,pointerType:aT.gesture.pointerType,deltaTime:aT.gesture.deltaTime,deltaX:aT.gesture.deltaX,deltaY:aT.gesture.deltaY,velocityX:aT.gesture.velocityX,velocityY:aT.gesture.velocityY,angle:aT.gesture.angle,direction:aT.gesture.direction,distance:aT.gesture.distance,scale:aT.gesture.scale,rotation:aT.gesture.rotation,eventStatus:aT.gesture.eventType,srcEventType:aT.gesture.srcEvent.type,startEvent:aS,touches:aU}};if(aL.stateful){aR.affectedComponents=ag.events.outgoing.touchObj[aT.type].affectedComponents.length>0?ag.events.outgoing.touchObj[aT.type].affectedComponents:[]}}aK(aR)}})}}function k(){var aQ=ag.events.outgoing.touch;if(aQ){if(aQ=="all"){aQ=a.map(r.touch.join(" "),A)}else{aQ=a.map(Object.keys(ag.events.outgoing.touchObj),A).join(" ")}a(document).hammer().off(aQ)}}function W(){if(ag.events.incoming.touch){a.each(ag.events.incoming.touch,function(aR,aQ){a(document).on(A(aR),aQ)})}}function aP(){if(ag&&ag.events&&ag.events.incoming&&ag.events.incoming.touch){a.each(ag.events.incoming.touch,function(aR,aQ){a(document).off(A(aR))})}}function ax(){var aQ=ag.events.outgoing.custom;if(aQ){aQ=a.map(Object.keys(ag.events.outgoing.customObj),A).join(" ");a(document).on(aQ,function(aT){if(!aT.namespace||aT.namespace!=x){var aR={timestamp:aT.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width}};var aS={type:aT.type,eventData:a.extend(true,{},aR,aT.eventData)};if(aL.stateful){aS.affectedComponents=ag.events.outgoing.customObj[aT.type].affectedComponents.length>0?ag.events.outgoing.customObj[aT.type].affectedComponents:[]}aK(aS)}})}}function p(){var aQ=ag.events.outgoing.custom;if(aQ){aQ=a.map(Object.keys(ag.events.outgoing.customObj),A).join(" ");a(document).off(aQ)}}function aE(){if(ag.events.incoming.custom){a.each(ag.events.incoming.custom,function(aQ,aR){a(document).on(A(aQ),aR)})}}function an(){if(ag&&ag.events&&ag.events.incoming&&ag.events.incoming.custom){a.each(ag.events.incoming.custom,function(aQ,aR){a(document).off(A(aQ))})}}function al(){if(window.WebSocket){if(a.isEmptyObject(d)){d=new WebSocket("ws://"+aL.ip+":"+aL.port+"/");d.onopen=ao;d.onmessage=aM;d.onerror=T;d.onclose=s;a("#mdRwdLayoutsBox .mdRwdLoadingBox").show();a("#mdRwdLayoutChoice").hide()}else{C("Waiting for WebSocket connection");return false}}else{C("The current browser does not support WebSockets");return false}}function Z(aQ){aQ=JSON.stringify(aQ);if(d.readyState===1){d.send(aQ)}else{C("WebSocket connection has been lost");return false}}function ao(aQ){v();aL.mdRwdOnWsOpen(aQ);ag.mdRwdOnWsOpen(aQ)}function T(aQ){aL.mdRwdOnWsError(aQ);if(!a.isEmptyObject(ag)){ag.mdRwdOnWsError(aQ)}}function s(aQ){if(aQ.code===1006){a("#mdRwdLayoutsBox .mdRwdLoadingBox").hide();a("#mdRwdLayoutChoice").html('<div class="mdRwdWarningMessage">'+aL.html.window.content.warningMessages[aQ.code]+"</div>");a("#mdRwdLayoutChoice").show()}aL.mdRwdOnWsClose(aQ.code,aQ);if(!a.isEmptyObject(ag)){ag.mdRwdOnWsClose(aQ.code,aQ)}}function aM(aR){var aQ=JSON.parse(aR.data);switch(aQ.cmd){case"newVc":am(aQ);break;case"connVc":ab(aQ);break;case"changeLayout":N(aQ);break;case"triggerVcEvent":E(aQ);break;case"rmVcClient":aC(aQ);break;case"rmVc":ai(aQ);break;default:break}aL.mdRwdOnWsMessage(aQ);ag.mdRwdOnWsMessage(aQ)}function v(){var aQ="";aQ+=e();aQ+=z();a("#mdRwdWindowContent").html(aQ);if(a("#mdRwdConnectVcId").length){a("#mdRwdConnectVcId").focus()}}function e(){var aQ="";if(a.inArray("newVc",ag.connectionTypesArray)>-1){M();aQ+='<div id="mdRwdVcCell" '+(ag.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aQ+='	<div id="mdRwdVcBox">';aQ+='	    <div id="mdRwdVcLabel">'+aL.html.window.content.vcLabel+"</div>";aQ+='         <div class="mdRwdLoadingBox">';aQ+='             <img src="'+aL.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aQ+="         </div>";aQ+='	    <div id="mdRwdVcId"></div>';aQ+="	</div>";aQ+="</div>"}return aQ}function z(){var aQ="";if(a.inArray("connVc",ag.connectionTypesArray)>-1){aQ+='<div id="mdRwdConnectVcCell" '+(ag.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aQ+='	<div id="mdRwdConnectVcBox">';aQ+='	    <div id="mdRwdConnectVcLabel">'+aL.html.window.content.connectVcLabel+"</div>";aQ+='         <div class="mdRwdLoadingBox">';aQ+='             <img src="'+aL.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aQ+="         </div>";aQ+='	    <div id="mdRwdConnectVc"><input type="text" pattern="[0-9]*" id="mdRwdConnectVcId"/><button id="mdRwdConnectVcButton">'+aL.html.window.content.connectVcButton+"</button></div>";aQ+="	</div>";aQ+="</div>";a(document).off("keydown","#mdRwdConnectVcId");a(document).on("keydown","#mdRwdConnectVcId",function(aR){if(aR.keyCode==13){a("#mdRwdConnectVcButton").trigger("click")}});a(document).off("click","#mdRwdConnectVcButton");a(document).on("click","#mdRwdConnectVcButton",function(){ac=a("#mdRwdConnectVcId").val();R()})}return aQ}function M(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();J={cmd:"newVc",vcId:"",client:{device:aq,layout:{id:ag.id}}};if(aL.stateful){J.initComponents={};a.each(aL.components,function(aQ,aR){J.initComponents[aQ]={};J.initComponents[aQ].id=aR.id;J.initComponents[aQ].state=aR.state});J.client.layout.components=aL.componentsArray}J.initLayouts={};a.each(aL.layouts,function(aR,aQ){J.initLayouts[aR]={};J.initLayouts[aR].id=aQ.id;J.initLayouts[aR].maxInstances=aQ.maxInstances;J.initLayouts[aR].instances=[]});Z(J)}function R(){a("#mdRwdConnectVc").hide();a("#mdRwdConnectVcBox .mdRwdLoadingBox").show();J={cmd:"connVc",vcId:ac,client:{device:aq,layout:{id:ag.id}}};if(aL.stateful){J.client.layout.components=ag.componentsArray}Z(J)}function af(aQ){if(aL.layouts[aQ]){if(aQ!=ag.id){if(a.inArray(aq.id,aL.layouts[aQ].devicesArray)>-1){var aR=ag;var aS=aL.layouts[aQ];ag=aS;J={cmd:"changeLayout",vcId:ac,client:{device:aq,layout:{id:ag.id},oldLayout:{id:aR.id}}};if(aL.stateful){J.client.layout.components=ag.componentsArray}Z(J)}else{C('The layout "'+aQ+'"  is not associated with the current "'+aq.id+'" device');return false}}else{C('The layout "'+aQ+'" is the current layout');return false}}else{C('The layout "'+aQ+'" does not exist');return false}}function am(aR){var aS={namespace:x,timeStamp:aR.timeStamp,type:aR.cmd,eventData:{},client:aR.client,vcId:aR.vcId,vcClients:aR.vcClients,vcLayouts:aR.vcLayouts};a("#mdRwdVcBox .mdRwdLoadingBox").hide();a("#mdRwdVcId").show();ac=aR.vcId;if(h==null&&aR.client.isMe){h=aR.client.id}if(aR.statusCode!=P){aL.mdRwdOnWarning(aR.statusCode);ag.mdRwdOnWarning(aR.statusCode);var aQ="";aQ+='<div class="mdRwdWarning">';aQ+=' <div class="mdRwdWarningMessage">'+aL.html.window.content.warningMessages[aR.statusCode]+"</div>";aQ+=' <div class="mdRwdWarningBackButton">'+aL.html.window.content.warningBackButton+"</div>";aQ+="</div>";a("#mdRwdVcId").html(aQ);a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdVcBox .mdRwdWarningBackButton",function(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();var aT="";aT+=e();a("#mdRwdVcCell").replaceWith(aT)})}else{a("#mdRwdVcId").html(ac);ag.events.incoming.mdRwd.newVc(aS,aR)}}function ab(aR){var aS={namespace:x,timeStamp:aR.timeStamp,type:aR.cmd,eventData:{},client:aR.client,vcId:aR.vcId,vcClients:aR.vcClients,vcLayouts:aR.vcLayouts};if(h==null&&aR.client.isMe){h=aR.client.id}if(aR.statusCode!=P){if(aR.lock){aO=Date.now();if(!X){X=true;au=aO}if(aO-au>aL.connVcTimeout){aL.mdRwdOnWarning(aR.statusCode);ag.mdRwdOnWarning(aR.statusCode);X=false;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aQ="";aQ+='<div class="mdRwdWarning">';aQ+=' <div class="mdRwdWarningMessage">'+aL.html.window.content.warningMessages[aR.statusCode]+"</div>";aQ+=' <div class="mdRwdWarningBackButton">'+aL.html.window.content.warningBackButton+"</div>";aQ+="</div>";a("#mdRwdConnectVc").html(aQ);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aT="";aT+=z();a("#mdRwdConnectVcCell").replaceWith(aT);a("#mdRwdConnectVcId").focus()})}else{setTimeout(function(){R()},aL.connVcInterval)}}else{aL.mdRwdOnWarning(aR.statusCode);ag.mdRwdOnWarning(aR.statusCode);a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aQ="";aQ+='<div class="mdRwdWarning">';aQ+=' <div class="mdRwdWarningMessage">'+aL.html.window.content.warningMessages[aR.statusCode]+"</div>";aQ+=' <div class="mdRwdWarningBackButton">'+aL.html.window.content.warningBackButton+"</div>";aQ+="</div>";a("#mdRwdConnectVc").html(aQ);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aT="";aT+=z();a("#mdRwdConnectVcCell").replaceWith(aT);a("#mdRwdConnectVcId").focus()})}}else{if(!av){av=true;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();if(aL.stateful){if(aR.client.isMe){l(aR.componentsFromServer)}}f.focus();aJ();n();aj();y();D(function(){ag.events.incoming.mdRwd.connVc(aS,aR);aL.mdRwdOnMultiDeviceMode();ag.mdRwdOnMultiDeviceMode();aG=ah})}else{ag.events.incoming.mdRwd.connVc(aS,aR)}}}function N(aQ){var aR={namespace:x,timeStamp:aQ.timeStamp,type:aQ.cmd,eventData:{},client:aQ.client,vcId:aQ.vcId,vcClients:aQ.vcClients,vcLayouts:aQ.vcLayouts};if(aQ.statusCode!=P){aL.mdRwdOnWarning(aQ.statusCode);ag.mdRwdOnWarning(aQ.statusCode)}else{if(aQ.client.isMe){a("link[href='"+aL.layouts[aQ.client.oldLayout.id].css+"']").remove();aN();H();V={};if(aL.stateful){l(aQ.componentsFromServer)}aJ();n();aj()}ag.events.incoming.mdRwd.changeLayout(aR,aQ)}}function E(aQ){var aR={namespace:x,timeStamp:aQ.timeStamp,type:aQ.event.type,eventData:aQ.event.eventData,client:aQ.client,vcId:aQ.vcId};if(aL.stateful){aR.affectedComponents=aQ.event.affectedComponents}Q(aR);ag.events.incoming.mdRwd.triggerVcEvent(aR,aQ)}function aC(aQ){var aR={namespace:x,timeStamp:aQ.timeStamp,type:aQ.cmd,eventData:{},client:aQ.client,vcId:aQ.vcId};ag.events.incoming.mdRwd.rmVcClient(aR,aQ)}function ai(aQ){var aR={namespace:x,timeStamp:aQ.timeStamp,type:aQ.cmd,eventData:{},client:aQ.client,vcId:aQ.vcId};ag.events.incoming.mdRwd.rmVc(aR,aQ)}function Q(aQ){a(document).trigger(aQ)}function l(aQ){if(aQ){a.each(aQ,function(aR,aS){aL.components[aR].state=a.extend(true,aL.components[aR].state,aS.state)})}}function ap(aQ,aR){if(aL.components[aQ]){aL.components[aQ].state=aR;if(ac!=null){at(aQ)}}else{C('The component "'+aQ+'" does not exist');return false}}function at(aR){var aQ={};aQ.id=aL.components[aR].id;aQ.state=aL.components[aR].state;J={cmd:"setVcCompState",vcId:ac,componentState:aQ,client:{device:aq,layout:{id:ag.id,components:ag.componentsArray}}};Z(J)}function aw(aQ){if(aL.components[aQ]){return aL.components[aQ].state}else{C('The component "'+aQ+'" does not exist');return false}}function ae(){return h}function S(){return ac}function q(){return aq}function i(){return ag}function t(){return aG}var c={};c={triggerVcEvent:Q,changeLayout:af,destroy:F,getMyId:ae,getMyVc:S,getMyDevice:q,getMyLayout:i,getMyAppMode:t};if(aL.stateful){c.setVcCompState=ap;c.getVcCompState=aw}return c}})(jQuery);