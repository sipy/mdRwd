/* 
 * mdRwd -  A jQuery/PHP framework for development of Web applications 
 *          partitioned in different communicating devices.
 * v0.1.0 - 2014-04-13
 * http://www.mdRwd.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of mdRwd.
 * 
 * mdRwd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * mdRwd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/

(function(a){a.fn.mdRwd=function(V){var e=a(this);var E="#"+e.attr("id");var p={mdRwd:["newVc","connVc","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var I={ip:"",port:"",debug:false,stateful:false,connVcInterval:500,connVcTimeout:10000,mdRwdOnInit:function(){},mdRwdOnDestroy:function(){},mdRwdOnWindowShow:function(){},mdRwdOnWindowHide:function(){},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aK,aL){},mdRwdOnWarning:function(aK){},mdRwdOnWsOpen:function(aK){},mdRwdOnWsMessage:function(aK){},mdRwdOnWsError:function(aK){},mdRwdOnWsClose:function(aK,aL){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{"1006":"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)","7000":"The virtual channel does not exist","7001":"You are allready conncetd to this virtual channel<br/>Try again","7002":"There is no available virtual channel<br/>Please try again later","7003":"The virtual channel is full<br/>Please try again later","7004":"The virtual channel for current IP is full<br/>Please try again later","7005":"The virtual channel is currently busy<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:Number.POSITIVE_INFINITY}},components:{},layouts:{}};var aF=a.extend(true,{},I,V);var al={};var u="mdRwd";var aF,c,H,al,ac,S,Z,g,y,o,L,u,ap,U,aI,ao;au();function au(){R();f();aA();af();k();t();z()}function R(){aF.connectionTypesArray=["newVc","connVc"];aF.componentsArray=Object.keys(aF.components);aF.devicesArray=Object.keys(aF.devices);aF.layoutsArray=Object.keys(aF.layouts);c={};H={};ac={};S={};Z="";g=0;y=25;o=25;L=5000;ap=false;U=false;aI="";ao=""}function D(){if(!a.isEmptyObject(c)){c.close();Q()}else{h()}}function h(){ay();z();if(ap){a("link[href='"+ac.css+"']").remove();aC();aH();F();B(function(){aF.mdRwdOnMonoDeviceMode();ac.mdRwdOnMonoDeviceMode()})}else{B()}R();aF.mdRwdOnDestroy()}function Q(){setTimeout(function(){if(c.readyState===3){h()}else{Q()}},o)}function z(){e.html(aF.html.connectButton);a(document).off("click",E);a(document).on("click",E,function(){aF.mdRwdOnInit();av();at()})}function v(){e.html(aF.html.disconnectButton);a(document).off("click",E);a(document).on("click",E,function(){D();z()})}function A(aK){D();if(aF.debug){a.error("mdRwd => "+aK)}}function k(){if(aF.devices){a.each(aF.devices,function(aL,aK){if(aK.minWidth&&aK.maxWidth){if(window.screen.width>=aK.minWidth&&window.screen.width<=aK.maxWidth){al=this}}else{A('The device "'+aL+'" must have "minWidh" and "maxWidth" properties');return false}})}}function f(){if(aF.devices){var aK={id:"",minWidth:0,maxWidth:0};a.each(aF.devices,function(aM,aL){aK.id=aM;aF.devices[aM]=a.extend(true,{},aK,aL)})}}function aA(){if(aF.components){var aK={id:"",selector:"",monoDeviceVisible:true};if(aF.stateful){aK.state={}}a.each(aF.components,function(aL,aM){aK.id=aL;aK.monoDeviceVisible=!a(aM.selector).is(":hidden");aF.components[aL]=a.extend(true,{},aK,aM)})}}function af(){var aL={};var aK={};a.each(p,function(aO,aN){aL[aO]="";aK[aO]={};if(aN.length>0){a.each(aN,function(aP,aQ){aK[aO][aQ]=function(){}})}});var aM={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",events:{outgoing:aL,incoming:aK},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aN,aO){},mdRwdOnWarning:function(aN){},mdRwdOnWsOpen:function(aN){},mdRwdOnWsMessage:function(aN){},mdRwdOnWsError:function(aN){},mdRwdOnWsClose:function(aN,aO){}};if(!a.isEmptyObject(aF.layouts)){a.each(aF.layouts,function(aO,aN){aN.connectionTypesArray=a.map(aN.connectionTypes.split(","),a.trim);a.each(aN.connectionTypesArray,function(aP,aQ){if(a.inArray(aQ,aF.connectionTypesArray)==-1){A('The connection type "'+aQ+'" of the layout "'+aO+'" does not exist (available connection types: "newVc", "connVc")');return false}});aN.devicesArray=a.map(aN.devices.split(","),a.trim);a.each(aN.devicesArray,function(aP,aQ){if(a.inArray(aQ,aF.devicesArray)==-1){A('The device "'+aQ+'" of the layout "'+aO+'" does not exist (available devices: "'+aF.devicesArray.join('", "')+'")');return false}});aN.componentsArray=a.map(aN.components.split(","),a.trim);a.each(aN.componentsArray,function(aQ,aP){if(a.inArray(aP,aF.componentsArray)==-1){A('The component "'+aP+'" of the layout "'+aO+'" does not exist (available components: "'+aF.componentsArray.join('", "')+'")');return false}});a.each(aN.events.outgoing,function(aQ,aP){aN.events.outgoing[aQ+"Obj"]={};var aR={};a.each(aP.match(/(?:[^,(]|\([^)]*\))+/g),function(aS,aT){aR=aB(aO,aQ,aT);if(aF.stateful){aN.events.outgoing[aQ+"Obj"][aR.event]={};aN.events.outgoing[aQ+"Obj"][aR.event].affectedComponents=aR.affectedComponents}})});aM.id=aO;aF.layouts[aO]=a.extend(true,{},aM,aN)})}else{A("You must define at least one layout");return false}}function aD(){a('<link href="'+ac.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");a("body").animate({scrollTop:0},"fast");a.each(aF.components,function(aK,aL){if(a.inArray(aK,ac.componentsArray)>-1){a(aL.selector).show()}else{a(aL.selector).hide()}})}function aC(){a.each(aF.components,function(aK,aL){if(aL.monoDeviceVisible){a(aL.selector).show()}else{a(aL.selector).hide()}})}function t(){var aL="";aL='<div id="mdRwdOverlay"></div>';var aK="";aK+='<div id="mdRwdWindow">';aK+='	<div id="mdRwdWindowHeader">';aK+='	    <div id="mdRwdWindowTitle">'+aF.html.window.header.title+"</div>";aK+='	    <div id="mdRwdWindowClose">'+aF.html.window.header.close+"</div>";aK+="	</div>";aK+='	<div id="mdRwdWindowContent"></div>';aK+="</div>";a("body").append(aL);a("body").append(aK)}function av(){if(a("#mdRwdWindow").is(":hidden")){a("#mdRwdWindow").slideDown("fast");a("#mdRwdOverlay").fadeIn("fast").promise().done(function(){aF.mdRwdOnWindowShow();a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).on("click","#mdRwdWindowClose, #mdRwdOverlay",function(){D()})})}}function B(aK){if(!a("#mdRwdOverlay").is(":hidden")){a("#mdRwdOverlay").fadeOut("fast");a("#mdRwdWindow").slideUp("fast").promise().done(function(){aF.mdRwdOnWindowHide();a("#mdRwdVcId").html("");a(".mdRwdWarningMessage").html("");if(aK){aK()}})}else{if(aK){aK()}}}function at(){var aL=[];a.each(aF.layouts,function(aN,aM){if(a.inArray(al.id,aM.devicesArray)>-1){aL.push(aN)}});var aK="";if(aL.length>1){aK+='<div id="mdRwdLayoutsCell">';aK+='	    <div id="mdRwdLayoutsBox">';aK+='             <div class="mdRwdLoadingBox">';aK+='                 <img src="'+aF.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aK+="             </div>";aK+='             <div id="mdRwdLayoutChoice">';aK+='                 <div id="mdRwdLayoutLabel">'+aF.html.window.content.layoutsLabel+"</div>";aK+='                 <div id="mdRwdLayouts">';a.each(aL,function(aN,aM){var aO=aF.layouts[aM];aK+='             <div class="mdRwdLayout mdRwdButton" layoutId="'+aM+'">';aK+='                 <div class="mdRwdLayoutName">'+aO.html.name+"</div>";aK+='                 <div class="mdRwdLayoutDescription">'+aO.html.description+"</div>";aK+="             </div>"});aK+="                 </div>";aK+="		</div>";aK+="	    </div>";aK+="</div>";a("#mdRwdWindowContent").html(aK);a(document).off("click",".mdRwdLayout");a(document).on("click",".mdRwdLayout",function(){ac=aF.layouts[a(this).attr("layoutId")];ag()})}else{if(aL.length==1){aK+='<div id="mdRwdLayoutsCell">';aK+='	    <div id="mdRwdLayoutsBox">';aK+='             <div class="mdRwdLoadingBox">';aK+='                 <img src="'+aF.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aK+="             </div>";aK+='             <div id="mdRwdLayoutChoice">';aK+="             </div>";aK+="         </div>";aK+="</div>";a("#mdRwdWindowContent").html(aK);ac=aF.layouts[aL[0]];ag()}else{A('The "'+al.id+'" device has no associated layouts');return false}}}function x(aK){return a.trim(aK)+"."+u}function aB(aL,aN,aO){var aK=aO.match(/\((.*?)\)/g);var aQ=[];var aP=a.trim(aO);var aM={};if(aK){aQ=a.trim(aO.match(/\((.*?)\)/g)[0]);aQ=aQ.slice(1,-1);aP=a.trim(aO.replace("("+aQ+")",""));aQ=a.map(aQ.split(","),a.trim);a.each(aQ,function(aS,aR){if(a.inArray(aR,aF.componentsArray)==-1){A('The affected component "'+aR+'" by the outgoing event "'+aP+'" of the layout "'+aL+'" does not exist');return false}})}if(aN!="custom"&&a.inArray(aP,p[aN])==-1){A('The outgoing event "'+aP+'" of the layout "'+aL+'" does not exist in the default "'+aN+'" events');return false}aM.event=aP;aM.affectedComponents=aQ;return aM}function l(){G();am();X();ar()}function ae(){r();J();T();az()}function ay(){a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).off("click",".mdRwdLayout");a(document).off("keydown","#mdRwdConnectVcId");a(document).off("click","#mdRwdConnectVcButton");a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton")}function aH(){b();m();i();n()}function F(){aa();aw();aJ();ai()}function aE(aK){H={cmd:"triggerVcEvent",vcId:Z,event:aK,client:{layout:{id:ac.id}}};if(aF.stateful){H.client.layout.components=ac.componentsArray}W(H)}function G(){var aK=ac.events.outgoing.keyboard;if(aK){if(aK=="all"){aK=a.map(p.keyboard.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.keyboardObj),x).join(" ")}a(document).on(aK,function(aM){if(!aM.namespace||aM.namespace!=u){var aL={type:aM.type,eventData:{timeStamp:aM.timeStamp,altKey:aM.altKey,shiftKey:aM.shiftKey,ctrlKey:aM.ctrlKey,metaKey:aM.metaKey,charCode:aM.charCode,keyCode:aM.keyCode}};if(aF.stateful){aL.affectedComponents=ac.events.outgoing.keyboardObj[aM.type].lenght>0?ac.events.outgoing.keyboardObj[aM.type].join(", "):""}aE(aL)}})}}function b(){var aK=ac.events.outgoing.keyboard;if(aK){if(aK=="all"){aK=a.map(p.keyboard.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.keyboardObj),x).join(" ")}a(document).off(aK)}}function r(){if(ac.events.incoming.keyboard){a.each(ac.events.incoming.keyboard,function(aK,aL){a(document).on(x(aK),aL)})}}function aa(){if(ac&&ac.events&&ac.events.incoming&&ac.events.incoming.keyboard){a.each(ac.events.incoming.keyboard,function(aK,aL){a(document).off(x(aK))})}}function am(){var aK=ac.events.outgoing.mouse;if(aK){if(aK=="all"){aK=a.map(p.mouse.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.mouseObj),x).join(" ")}a(document).on(aK,function(aL){if(!aL.namespace||aL.namespace!=u){var aM={type:aL.type,eventData:{timeStamp:aL.timeStamp,altKey:aL.altKey,shiftKey:aL.shiftKey,ctrlKey:aL.ctrlKey,metaKey:aL.metaKey,button:aL.button,center:{pageX:aL.pageX,pageY:aL.pageY},target:aL.target.id}};if(aF.stateful){aM.affectedComponents=ac.events.outgoing.mouseObj[aL.type].affectedComponents.length>0?ac.events.outgoing.mouseObj[aL.type].affectedComponents:[]}aE(aM)}})}}function m(){var aK=ac.events.outgoing.mouse;if(aK){if(aK=="all"){aK=a.map(p.mouse.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.mouseObj),x).join(" ")}a(document).off(aK)}}function J(){if(ac.events.incoming.mouse){a.each(ac.events.incoming.mouse,function(aL,aK){a(document).on(x(aL),aK)})}}function aw(){if(ac&&ac.events&&ac.events.incoming&&ac.events.incoming.mouse){a.each(ac.events.incoming.mouse,function(aL,aK){a(document).off(x(aL))})}}function X(){var aK=ac.events.outgoing.touch;if(aK){if(aK=="all"){aK=a.map(p.touch.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.touchObj),x).join(" ")}a(document).hammer({prevent_default:true}).on(aK,function(aN){if(!aN.namespace||aN.namespace!=u){var aO=[];var aL={};var aM={};if(aN.gesture){if(aN.gesture.startEvent.touches){a.each(aN.gesture.startEvent.touches,function(aP,aQ){aO.push({type:aQ.type,eventData:{center:{pageX:aQ.pageX,pageY:aQ.pageY},parentOffsetX:aQ.offsetX,parentOffsetY:aQ.offsetY,target:aQ.target.id}})})}aM={type:aN.type,eventData:{timeStamp:aN.gesture.startEvent.timeStamp,target:aN.gesture.startEvent.target.id,center:aN.gesture.startEvent.center,pointerType:aN.gesture.startEvent.pointerType,eventType:aN.gesture.startEvent.eventType,srcEventType:aN.gesture.startEvent.srcEvent.type,touches:aO}};if(aN.gesture.touches){aO=[];a.each(aN.gesture.touches,function(aP,aQ){aO.push({type:aQ.type,eventData:{center:{pageX:aQ.pageX,pageY:aQ.pageY},parentOffsetX:aQ.offsetX,parentOffsetY:aQ.offsetY,target:aQ.target.id}})})}aL={type:aN.type,eventData:{timeStamp:aN.gesture.timeStamp,screenDim:{height:a(window).height(),width:a(window).width()},target:aN.gesture.target.id,center:aN.gesture.center,pointerType:aN.gesture.pointerType,deltaTime:aN.gesture.deltaTime,deltaX:aN.gesture.deltaX,deltaY:aN.gesture.deltaY,velocityX:aN.gesture.velocityX,velocityY:aN.gesture.velocityY,angle:aN.gesture.angle,direction:aN.gesture.direction,distance:aN.gesture.distance,scale:aN.gesture.scale,rotation:aN.gesture.rotation,eventStatus:aN.gesture.eventType,srcEventType:aN.gesture.srcEvent.type,startEvent:aM,touches:aO}};if(aF.stateful){aL.affectedComponents=ac.events.outgoing.touchObj[aN.type].affectedComponents.length>0?ac.events.outgoing.touchObj[aN.type].affectedComponents:[]}}aE(aL)}})}}function i(){var aK=ac.events.outgoing.touch;if(aK){if(aK=="all"){aK=a.map(p.touch.join(" "),x)}else{aK=a.map(Object.keys(ac.events.outgoing.touchObj),x).join(" ")}a(document).hammer().off(aK)}}function T(){if(ac.events.incoming.touch){a.each(ac.events.incoming.touch,function(aL,aK){a(document).on(x(aL),aK)})}}function aJ(){if(ac&&ac.events&&ac.events.incoming&&ac.events.incoming.touch){a.each(ac.events.incoming.touch,function(aL,aK){a(document).off(x(aL))})}}function ar(){var aK=ac.events.outgoing.custom;if(aK){aK=a.map(Object.keys(ac.events.outgoing.customObj),x).join(" ");a(document).on(aK,function(aM){if(!aM.namespace||aM.namespace!=u){var aL={type:aM.type,eventData:aM.eventData?aM.eventData:{}};if(aF.stateful){aL.affectedComponents=ac.events.outgoing.customObj[aM.type].affectedComponents.length>0?ac.events.outgoing.customObj[aM.type].affectedComponents:[]}aE(aL)}})}}function n(){var aK=ac.events.outgoing.custom;if(aK){aK=a.map(Object.keys(ac.events.outgoing.customObj),x).join(" ");a(document).off(aK)}}function az(){if(ac.events.incoming.custom){a.each(ac.events.incoming.custom,function(aK,aL){a(document).on(x(aK),aL)})}}function ai(){if(ac&&ac.events&&ac.events.incoming&&ac.events.incoming.custom){a.each(ac.events.incoming.custom,function(aK,aL){a(document).off(x(aK))})}}function ag(){if(window.WebSocket){if(a.isEmptyObject(c)){c=new WebSocket("ws://"+aF.ip+":"+aF.port+"/");c.onopen=aj;a("#mdRwdLayoutsBox .mdRwdLoadingBox").show();a("#mdRwdLayoutChoice").hide();O()}else{A("Waiting for WebSocket connection");return false}}else{A("The current browser does not support WebSockets");return false}}function O(){setTimeout(function(){if(c.readyState===1){c.onmessage=aG;c.onerror=P;c.onclose=q}else{if(c.readyState===3){a("#mdRwdLayoutsBox .mdRwdLoadingBox").hide();a("#mdRwdLayoutChoice").html('<div class="mdRwdWarningMessage">'+aF.html.window.content.warningMessages[1006]+"</div>");a("#mdRwdLayoutChoice").show()}else{O()}}},y)}function W(aK){aK=JSON.stringify(aK);if(c.readyState===1){c.send(aK)}else{A("WebSocket connection has been lost");return false}}function aj(aK){s();aF.mdRwdOnWsOpen(aK);ac.mdRwdOnWsOpen(aK)}function P(aK){aF.mdRwdOnWsError(aK);ac.mdRwdOnWsError(aK)}function q(aK){aF.mdRwdOnWsClose(aK.code,aK);ac.mdRwdOnWsClose(aK.code,aK)}function aG(aM){var aK=JSON.parse(aM.data);var aL={namespace:u,timeStamp:aK.timeStamp,type:aK.cmd=="triggerVcEvent"?aK.event.type:aK.cmd,eventData:aK.cmd=="triggerVcEvent"?aK.event.eventData:null,client:aK.client,vcId:aK.vcId};switch(aK.cmd){case"newVc":ah(aL,aK);break;case"connVc":Y(aL,aK);break;case"triggerVcEvent":C(aL,aK);break;case"rmVcClient":ax(aL,aK);break;case"rmVc":ad(aL,aK);break;default:break}aF.mdRwdOnWsMessage(aM,aK);ac.mdRwdOnWsMessage(aM,aK)}function s(){var aK="";aK+=d();aK+=w();a("#mdRwdWindowContent").html(aK);if(a("#mdRwdConnectVcId").length){a("#mdRwdConnectVcId").focus()}}function d(){var aK="";if(a.inArray("newVc",ac.connectionTypesArray)>-1){K();aK+='<div id="mdRwdVcCell" '+(ac.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aK+='	<div id="mdRwdVcBox">';aK+='	    <div id="mdRwdVcLabel">'+aF.html.window.content.vcLabel+"</div>";aK+='         <div class="mdRwdLoadingBox">';aK+='             <img src="'+aF.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aK+="         </div>";aK+='	    <div id="mdRwdVcId"></div>';aK+="	</div>";aK+="</div>"}return aK}function w(){var aK="";if(a.inArray("connVc",ac.connectionTypesArray)>-1){aK+='<div id="mdRwdConnectVcCell" '+(ac.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aK+='	<div id="mdRwdConnectVcBox">';aK+='	    <div id="mdRwdConnectVcLabel">'+aF.html.window.content.connectVcLabel+"</div>";aK+='         <div class="mdRwdLoadingBox">';aK+='             <img src="'+aF.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aK+="         </div>";aK+='	    <div id="mdRwdConnectVc"><input type="text" pattern="[0-9]*" id="mdRwdConnectVcId"/><button id="mdRwdConnectVcButton">'+aF.html.window.content.connectVcButton+"</button></div>";aK+="	</div>";aK+="</div>";a(document).off("keydown","#mdRwdConnectVcId");a(document).on("keydown","#mdRwdConnectVcId",function(aL){if(aL.keyCode==13){a("#mdRwdConnectVcButton").trigger("click")}});a(document).off("click","#mdRwdConnectVcButton");a(document).on("click","#mdRwdConnectVcButton",function(){Z=a("#mdRwdConnectVcId").val();N(false)})}return aK}function K(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();H={cmd:"newVc",vcId:"",client:{layout:{id:ac.id}}};if(aF.stateful){H.initComponents={};a.each(aF.components,function(aK,aL){H.initComponents[aK]={};H.initComponents[aK].id=aL.id;H.initComponents[aK].state=aL.state});H.client.layout.components=aF.componentsArray}W(H)}function ah(aM,aL){a("#mdRwdVcBox .mdRwdLoadingBox").hide();a("#mdRwdVcId").show();Z=aL.vcId;if(g==0&&aL.client.isMe){g=aL.client.id}if(aL.statusCode!=L){aF.mdRwdOnWarning(aL.statusCode);ac.mdRwdOnWarning(aL.statusCode);var aK="";aK+='<div class="mdRwdWarning">';aK+=' <div class="mdRwdWarningMessage">'+aF.html.window.content.warningMessages[aL.statusCode]+"</div>";aK+=' <div class="mdRwdWarningBackButton">'+aF.html.window.content.warningBackButton+"</div>";aK+="</div>";a("#mdRwdVcId").html(aK);a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdVcBox .mdRwdWarningBackButton",function(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();var aN="";aN+=d();a("#mdRwdVcCell").replaceWith(aN)})}else{a("#mdRwdVcId").html(Z);ac.events.incoming.mdRwd.newVc(aM,aL)}}function N(aK){a("#mdRwdConnectVc").hide();a("#mdRwdConnectVcBox .mdRwdLoadingBox").show();H={cmd:"connVc",vcId:Z,changeLayout:aK,client:{layout:{id:ac.id}}};if(aF.stateful){H.client.layout.components=ac.componentsArray}W(H)}function Y(aM,aL){if(g==0&&aL.client.isMe){g=aL.client.id}if(aL.statusCode!=L){if(aL.lock){aI=Date.now();if(!U){U=true;ao=aI}if(aI-ao>aF.connVcTimeout){aF.mdRwdOnWarning(aL.statusCode);ac.mdRwdOnWarning(aL.statusCode);U=false;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aK="";aK+='<div class="mdRwdWarning">';aK+=' <div class="mdRwdWarningMessage">'+aF.html.window.content.warningMessages[aL.statusCode]+"</div>";aK+=' <div class="mdRwdWarningBackButton">'+aF.html.window.content.warningBackButton+"</div>";aK+="</div>";a("#mdRwdConnectVc").html(aK);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aN="";aN+=w();a("#mdRwdConnectVcCell").replaceWith(aN);a("#mdRwdConnectVcId").focus()})}else{setTimeout(function(){N(false)},aF.connVcInterval)}}else{aF.mdRwdOnWarning(aL.statusCode);ac.mdRwdOnWarning(aL.statusCode);a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aK="";aK+='<div class="mdRwdWarning">';aK+=' <div class="mdRwdWarningMessage">'+aF.html.window.content.warningMessages[aL.statusCode]+"</div>";aK+=' <div class="mdRwdWarningBackButton">'+aF.html.window.content.warningBackButton+"</div>";aK+="</div>";a("#mdRwdConnectVc").html(aK);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aN="";aN+=w();a("#mdRwdConnectVcCell").replaceWith(aN);a("#mdRwdConnectVcId").focus()})}}else{if(!ap){ap=true;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();if(aF.stateful){if(aL.client.isMe){j(aL.componentsFromServer)}}B(function(){aF.mdRwdOnMultiDeviceMode();ac.mdRwdOnMultiDeviceMode()});e.focus();aD();l();ae();v()}ac.events.incoming.mdRwd.connVc(aM,aL)}}function C(aL,aK){M(aL);ac.events.incoming.mdRwd.triggerVcEvent(aL,aK)}function ax(aL,aK){ac.events.incoming.mdRwd.rmVcClient(aL,aK)}function ad(aL,aK){ac.events.incoming.mdRwd.rmVc(aL,aK)}function M(aK){a(document).trigger(aK)}function j(aK){if(aK){a.each(aK,function(aL,aM){ak(aL,aM.state,false)})}}function ak(aK,aL,aM){if(aF.components[aK]){aF.components[aK].state=aL;aM=typeof aM!=="undefined"?aM:false;if(aM){an(aK)}}else{A('The component "'+aK+'" does not exist');return false}}function an(aL){var aK={};aK.id=aF.components[aL].id;aK.state=aF.components[aL].state;H={cmd:"setVcCompState",vcId:Z,componentState:aK,client:{layout:{id:ac.id,components:ac.componentsArray}}};W(H)}function aq(aK){if(aF.components[aK]){return aF.components[aK].state}else{A('The component "'+aK+'" does not exist');return false}}function ab(aK){if(aF.layouts[aK]){if(aK!=ac.id){if(a.inArray(al.id,aF.layouts[aK].devicesArray)>-1){aH();F();S={};aF.mdRwdOnChangeLayout(ac.id,aK);ac.mdRwdOnChangeLayout(ac.id,aK);ac=aF.layouts[aK];ap=false;U=false;N(true)}else{A('The layout "'+aK+'"  is not associated with the current "'+al.id+'" device');return false}}else{A('The layout "'+aK+'" is the current layout');return false}}else{A('The layout "'+aK+'" does not exist');return false}}if(aF.stateful){return{triggerVcEvent:M,setVcCompState:ak,getVcCompState:aq,changeLayout:ab}}else{return{triggerVcEvent:M,changeLayout:ab}}}})(jQuery);