/* 
 * mdRwd -  A framework for development of Web applications 
 *          partitioned in different communicating devices.
 * http://www.mdRwd.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of mdRwd.
 * 
 * mdRwd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * mdRwd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/

(function(a){a.fn.mdRwd=function(Z){var f=a(this);var H="#"+f.attr("id");var s={mdRwd:["newVc","connVc","changeLayout","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var L={ip:"",port:"",debug:false,stateful:false,autoManageStates:false,connVcInterval:500,connVcTimeout:10000,mdRwdOnInit:function(){},mdRwdOnDestroy:function(){},mdRwdOnWindowShow:function(){},mdRwdOnWindowHide:function(){},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnWarning:function(aR){},mdRwdOnWsOpen:function(aR){},mdRwdOnWsMessage:function(aR){},mdRwdOnWsError:function(aR){},mdRwdOnWsClose:function(aR,aS){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"../../lib/img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{"1006":"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)","7000":"The virtual channel does not exist","7001":"You are allready conncetd to this virtual channel<br/>Try again","7002":"There is no available virtual channel<br/>Please try again later","7003":"The virtual channel is full<br/>Please try again later","7004":"The virtual channel for current IP is full<br/>Please try again later","7005":"The virtual channel is currently busy<br/>Please try again later","7006":"The virtual channel for current layout is full<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:4096}},components:{},layouts:{}};var aM=a.extend(true,{},L,Z);var ar={};var y="mdRwd";var aM,d,K,ar,ah,W,ad,h,P,ai,aH,aw,Q,y,Y,aP,av;aA();function aA(){V();g();aG();al();m();x();C()}function V(){aM.connectionTypesArray=["newVc","connVc"];aM.componentsArray=Object.keys(aM.components);aM.devicesArray=Object.keys(aM.devices);aM.layoutsArray=Object.keys(aM.layouts);d={};K={};ah={};W={};ad=null;h=null;P="monoDevice";ai="multiDevice";aH=P;aw=false;Q=5000;aw=false;Y=false;aP=null;av=null}function G(){if(!a.isEmptyObject(d)){d.close()}j()}function j(){C();aE();C();if(aw){a("link[href='"+ah.css+"']").remove();aJ();aO();I();E(function(){aM.mdRwdOnMonoDeviceMode();ah.mdRwdOnMonoDeviceMode()})}else{E()}V();aM.mdRwdOnDestroy()}function C(){f.html(aM.html.connectButton);a(document).off("click touchend",H);a(document).on("click touchend",H,function(){aM.mdRwdOnInit();aB();az()})}function z(){f.html(aM.html.disconnectButton);a(document).off("click touchend",H);a(document).on("click touchend",H,function(){G()})}function D(aR){G();if(aM.debug){a.error("mdRwd => "+aR)}}function m(){a.each(aM.devices,function(aS,aR){if(aR.minWidth&&aR.maxWidth){if(window.screen.width>=aR.minWidth&&window.screen.width<=aR.maxWidth){ar=aR;ar.screenWidth=window.screen.width;ar.screenHeight=window.screen.height}}else{D('The device "'+aS+'" must have "minWidh" and "maxWidth" properties');return false}})}function g(){var aR={id:"",minWidth:0,maxWidth:0};a.each(aM.devices,function(aT,aS){aR.id=aT;aM.devices[aT]=a.extend(true,{},aR,aS)})}function aG(){if(!a.isEmptyObject(aM.components)){var aR={id:"",selector:"",monoDeviceVisible:true};if(aM.stateful){aR.state={}}a.each(aM.components,function(aS,aT){aR.id=aS;aR.monoDeviceVisible=!a(aT.selector).is(":hidden");aM.components[aS]=a.extend(true,{},aR,aT);aM.components[aS].state=Z.components[aS].state})}else{D("You must define at least one component");return false}}function al(){var aS={};var aR={};aS.mdRwd="";aR.mdRwd={};a.each(s.mdRwd,function(aU,aV){aR.mdRwd[aV]=function(){}});var aT={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",maxInstances:-1,hidden:false,events:{outgoing:aS,incoming:aR},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnWarning:function(aU){},mdRwdOnWsOpen:function(aU){},mdRwdOnWsMessage:function(aU){},mdRwdOnWsError:function(aU){},mdRwdOnWsClose:function(aU,aV){}};if(!a.isEmptyObject(aM.layouts)){a.each(aM.layouts,function(aV,aU){aU.connectionTypesArray=a.map(aU.connectionTypes.split(","),a.trim);a.each(aU.connectionTypesArray,function(aW,aX){if(a.inArray(aX,aM.connectionTypesArray)==-1){D('The connection type "'+aX+'" of the layout "'+aV+'" does not exist (available connection types: "newVc", "connVc")');return false}});aU.devicesArray=a.map(aU.devices.split(","),a.trim);a.each(aU.devicesArray,function(aW,aX){if(a.inArray(aX,aM.devicesArray)==-1){D('The device "'+aX+'" of the layout "'+aV+'" does not exist (available devices: "'+aM.devicesArray.join('", "')+'")');return false}});aU.componentsArray=a.map(aU.components.split(","),a.trim);a.each(aU.componentsArray,function(aX,aW){if(a.inArray(aW,aM.componentsArray)==-1){D('The component "'+aW+'" of the layout "'+aV+'" does not exist (available components: "'+aM.componentsArray.join('", "')+'")');return false}});a.each(aU.events.outgoing,function(aX,aW){aU.events.outgoing[aX+"Obj"]={};var aY={};a.each(aW.match(/(?:[^,(]|\([^)]*\))+/g),function(aZ,a0){aY=aI(aV,aX,a0);aU.events.outgoing[aX+"Obj"][aY.event]={};if(aM.stateful){aU.events.outgoing[aX+"Obj"][aY.event].affectedComponents=aY.affectedComponents}})});aT.id=aV;aM.layouts[aV]=a.extend(true,{},aT,aU)})}else{D("You must define at least one layout");return false}}function aK(){a('<link href="'+ah.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");a("body").animate({scrollTop:0},"fast");a.each(aM.components,function(aR,aS){if(a.inArray(aR,ah.componentsArray)>-1){a(aS.selector).show()}else{a(aS.selector).hide()}})}function aJ(){a.each(aM.components,function(aR,aS){if(aS.monoDeviceVisible){a(aS.selector).show()}else{a(aS.selector).hide()}})}function x(){var aS="";aS='<div id="mdRwdOverlay"></div>';var aR="";aR+='<div id="mdRwdWindow">';aR+='	<div id="mdRwdWindowHeader">';aR+='	    <div id="mdRwdWindowTitle">'+aM.html.window.header.title+"</div>";aR+='	    <div id="mdRwdWindowClose">'+aM.html.window.header.close+"</div>";aR+="	</div>";aR+='	<div id="mdRwdWindowContent"></div>';aR+='	<img src="'+aM.html.window.content.loadingImgPath+'" style="display:none;"/>';aR+="</div>";a("body").append(aS);a("body").append(aR)}function aB(){if(a("#mdRwdWindow").is(":hidden")){a("#mdRwdWindow").slideDown("fast");a("#mdRwdOverlay").fadeIn("fast").promise().done(function(){aM.mdRwdOnWindowShow();a(document).off("click touchend","#mdRwdWindowClose, #mdRwdOverlay");a(document).on("click touchend","#mdRwdWindowClose, #mdRwdOverlay",function(){G()})})}}function E(aR){if(!a("#mdRwdOverlay").is(":hidden")){a("#mdRwdOverlay").fadeOut("fast");a("#mdRwdWindow").slideUp("fast").promise().done(function(){aM.mdRwdOnWindowHide();a("#mdRwdVcId").html("");a(".mdRwdWarningMessage").html("");if(aR){aR()}})}else{if(aR){aR()}}}function az(){var aS=[];a.each(aM.layouts,function(aU,aT){if(a.inArray(ar.id,aT.devicesArray)>-1&&!aT.hidden){aS.push(aU)}});var aR="";if(aS.length>1){aR+='<div id="mdRwdLayoutsCell">';aR+='	    <div id="mdRwdLayoutsBox">';aR+='             <div class="mdRwdLoadingBox">';aR+='                 <img src="'+aM.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aR+="             </div>";aR+='             <div id="mdRwdLayoutChoice">';aR+='                 <div id="mdRwdLayoutLabel">'+aM.html.window.content.layoutsLabel+"</div>";aR+='                 <div id="mdRwdLayouts">';a.each(aS,function(aU,aT){var aV=aM.layouts[aT];aR+='             <div class="mdRwdLayout mdRwdButton" layoutId="'+aT+'">';aR+='                 <div class="mdRwdLayoutName">'+aV.html.name+"</div>";aR+='                 <div class="mdRwdLayoutDescription">'+aV.html.description+"</div>";aR+="             </div>"});aR+="                 </div>";aR+="		</div>";aR+="	    </div>";aR+="</div>";a("#mdRwdWindowContent").html(aR);a(document).off("click touchend",".mdRwdLayout");a(document).on("click touchend",".mdRwdLayout",function(){ah=aM.layouts[a(this).attr("layoutId")];am()})}else{if(aS.length==1){aR+='<div id="mdRwdLayoutsCell">';aR+='	    <div id="mdRwdLayoutsBox">';aR+='             <div class="mdRwdLoadingBox">';aR+='                 <img src="'+aM.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aR+="             </div>";aR+='             <div id="mdRwdLayoutChoice">';aR+="             </div>";aR+="         </div>";aR+="</div>";a("#mdRwdWindowContent").html(aR);ah=aM.layouts[aS[0]];am()}else{D('The "'+ar.id+'" device has no associated visibile layouts');return false}}}function B(aR){return a.trim(aR)+"."+y}function aI(aS,aU,aV){var aR=aV.match(/\((.*?)\)/g);var aX=[];var aW=a.trim(aV);var aT={};if(aR){aX=a.trim(aV.match(/\((.*?)\)/g)[0]);aX=aX.slice(1,-1);aW=a.trim(aV.replace("("+aX+")",""));aX=a.map(aX.split(","),a.trim);a.each(aX,function(aZ,aY){if(a.inArray(aY,aM.componentsArray)==-1){D('The affected component "'+aY+'" by the outgoing event "'+aW+'" of the layout "'+aS+'" does not exist');return false}})}if(aU!="custom"&&a.inArray(aW,s[aU])==-1){D('The outgoing event "'+aW+'" of the layout "'+aS+'" does not exist in the default "'+aU+'" events');return false}aT.event=aW;aT.affectedComponents=aX;return aT}function n(){J();at();ab();ay()}function ak(){v();M();X();aF()}function aE(){a(document).off("click touchend","#mdRwdWindowClose, #mdRwdOverlay");a(document).off("click touchend",".mdRwdLayout");a(document).off("keydown","#mdRwdConnectVcId");a(document).off("click touchend","#mdRwdConnectVcButton");a(document).off("click touchend","#mdRwdVcBox .mdRwdWarningBackButton");a(document).off("click touchend","#mdRwdConnectVcBox .mdRwdWarningBackButton")}function aO(){b();o();k();q()}function I(){ae();aC();aQ();ao()}function aL(aR){K={cmd:"triggerVcEvent",vcId:ad,event:aR,client:{device:ar,layout:{id:ah.id}}};if(aM.stateful){K.client.layout.components=ah.componentsArray}aa(K)}function J(){var aR=ah.events.outgoing.keyboard;if(aR){if(aR=="all"){aR=a.map(s.keyboard.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.keyboardObj),B).join(" ")}a(document).on(aR,function(aT){if(!aT.namespace||aT.namespace!=y){var aS={type:aT.type,eventData:{timeStamp:aT.timeStamp,altKey:aT.altKey,shiftKey:aT.shiftKey,ctrlKey:aT.ctrlKey,metaKey:aT.metaKey,charCode:aT.charCode,keyCode:aT.keyCode}};if(aM.stateful){aS.affectedComponents=ah.events.outgoing.keyboardObj[aT.type].lenght>0?ah.events.outgoing.keyboardObj[aT.type].join(", "):""}aL(aS)}})}}function b(){var aR=ah.events.outgoing.keyboard;if(aR){if(aR=="all"){aR=a.map(s.keyboard.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.keyboardObj),B).join(" ")}a(document).off(aR)}}function v(){if(ah.events.incoming.keyboard){a.each(ah.events.incoming.keyboard,function(aR,aS){a(document).on(B(aR),function(aT){aS(aT);if(aM.stateful&&aM.autoManageStates){a.each(aT.affectedComponents,function(aV,aU){aq(aU,aM.components[aU].state)})}})})}}function ae(){if(ah&&ah.events&&ah.events.incoming&&ah.events.incoming.keyboard){a.each(ah.events.incoming.keyboard,function(aR,aS){a(document).off(B(aR))})}}function at(){var aR=ah.events.outgoing.mouse;if(aR){if(aR=="all"){aR=a.map(s.mouse.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.mouseObj),B).join(" ")}a(document).on(aR,function(aS){if(!aS.namespace||aS.namespace!=y){var aT={type:aS.type,eventData:{timeStamp:aS.timeStamp,altKey:aS.altKey,shiftKey:aS.shiftKey,ctrlKey:aS.ctrlKey,metaKey:aS.metaKey,button:aS.button,center:{pageX:aS.pageX,pageY:aS.pageY},target:{id:aS.target.id,classes:aS.target.className.split(" ")}}};if(aM.stateful){aT.affectedComponents=ah.events.outgoing.mouseObj[aS.type].affectedComponents.length>0?ah.events.outgoing.mouseObj[aS.type].affectedComponents:[]}aL(aT)}})}}function o(){var aR=ah.events.outgoing.mouse;if(aR){if(aR=="all"){aR=a.map(s.mouse.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.mouseObj),B).join(" ")}a(document).off(aR)}}function M(){if(ah.events.incoming.mouse){a.each(ah.events.incoming.mouse,function(aS,aR){a(document).on(B(aS),function(aT){aR(aT);if(aM.stateful&&aM.autoManageStates){a.each(aT.affectedComponents,function(aV,aU){aq(aU,aM.components[aU].state)})}})})}}function aC(){if(ah&&ah.events&&ah.events.incoming&&ah.events.incoming.mouse){a.each(ah.events.incoming.mouse,function(aS,aR){a(document).off(B(aS))})}}function ab(){var aR=ah.events.outgoing.touch;if(aR){if(aR=="all"){aR=a.map(s.touch.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.touchObj),B).join(" ")}a(document).hammer({prevent_default:true}).on(aR,function(aU){if(!aU.namespace||aU.namespace!=y){var aV=[];var aS={};var aT={};if(aU.gesture){if(aU.gesture.startEvent.touches){a.each(aU.gesture.startEvent.touches,function(aW,aX){aV.push({type:aX.type,eventData:{center:{pageX:aX.pageX,pageY:aX.pageY},parentOffsetX:aX.offsetX,parentOffsetY:aX.offsetY,target:{id:aX.target.id,classes:aX.target.className.split(" ")}}})})}aT={type:aU.type,eventData:{timeStamp:aU.gesture.startEvent.timeStamp,target:{id:aU.gesture.target.id,classes:aU.gesture.target.className.split(" ")},center:aU.gesture.startEvent.center,pointerType:aU.gesture.startEvent.pointerType,eventType:aU.gesture.startEvent.eventType,srcEventType:aU.gesture.startEvent.srcEvent.type,touches:aV}};if(aU.gesture.touches){aV=[];a.each(aU.gesture.touches,function(aW,aX){aV.push({type:aX.type,eventData:{center:{pageX:aX.pageX,pageY:aX.pageY},parentOffsetX:aX.offsetX,parentOffsetY:aX.offsetY,target:{id:aX.target.id,classes:aX.target.className.split(" ")}}})})}aS={type:aU.type,eventData:{timeStamp:aU.gesture.timeStamp,screenDim:{height:a(window).height(),width:a(window).width()},target:{id:aU.gesture.target.id,classes:aU.gesture.target.className.split(" ")},center:aU.gesture.center,pointerType:aU.gesture.pointerType,deltaTime:aU.gesture.deltaTime,deltaX:aU.gesture.deltaX,deltaY:aU.gesture.deltaY,velocityX:aU.gesture.velocityX,velocityY:aU.gesture.velocityY,angle:aU.gesture.angle,direction:aU.gesture.direction,distance:aU.gesture.distance,scale:aU.gesture.scale,rotation:aU.gesture.rotation,eventStatus:aU.gesture.eventType,srcEventType:aU.gesture.srcEvent.type,startEvent:aT,touches:aV}};if(aM.stateful){aS.affectedComponents=ah.events.outgoing.touchObj[aU.type].affectedComponents.length>0?ah.events.outgoing.touchObj[aU.type].affectedComponents:[]}}aL(aS)}})}}function k(){var aR=ah.events.outgoing.touch;if(aR){if(aR=="all"){aR=a.map(s.touch.join(" "),B)}else{aR=a.map(Object.keys(ah.events.outgoing.touchObj),B).join(" ")}a(document).hammer().off(aR)}}function X(){if(ah.events.incoming.touch){a.each(ah.events.incoming.touch,function(aS,aR){a(document).on(B(aS),function(aT){aR(aT);if(aM.stateful&&aM.autoManageStates){a.each(aT.affectedComponents,function(aV,aU){aq(aU,aM.components[aU].state)})}})})}}function aQ(){if(ah&&ah.events&&ah.events.incoming&&ah.events.incoming.touch){a.each(ah.events.incoming.touch,function(aS,aR){a(document).off(B(aS))})}}function ay(){var aR=ah.events.outgoing.custom;if(aR){aR=a.map(Object.keys(ah.events.outgoing.customObj),B).join(" ");a(document).on(aR,function(aT){if(!aT.namespace||aT.namespace!=y){var aS={type:aT.type,eventData:aT.eventData?aT.eventData:{}};if(aM.stateful){aS.affectedComponents=ah.events.outgoing.customObj[aT.type].affectedComponents.length>0?ah.events.outgoing.customObj[aT.type].affectedComponents:[]}aL(aS)}})}}function q(){var aR=ah.events.outgoing.custom;if(aR){aR=a.map(Object.keys(ah.events.outgoing.customObj),B).join(" ");a(document).off(aR)}}function aF(){if(ah.events.incoming.custom){a.each(ah.events.incoming.custom,function(aR,aS){a(document).on(B(aR),function(aT){aS(aT);if(aM.stateful&&aM.autoManageStates){a.each(aT.affectedComponents,function(aV,aU){aq(aU,aM.components[aU].state)})}})})}}function ao(){if(ah&&ah.events&&ah.events.incoming&&ah.events.incoming.custom){a.each(ah.events.incoming.custom,function(aR,aS){a(document).off(B(aR))})}}function am(){if(window.WebSocket){if(a.isEmptyObject(d)){d=new WebSocket("ws://"+aM.ip+":"+aM.port+"/");d.onopen=ap;d.onmessage=aN;d.onerror=U;d.onclose=t;a("#mdRwdLayoutsBox .mdRwdLoadingBox").show();a("#mdRwdLayoutChoice").hide()}else{D("Waiting for WebSocket connection");return false}}else{D("The current browser does not support WebSockets");return false}}function aa(aR){aR=JSON.stringify(aR);if(d.readyState===1){d.send(aR)}else{D("WebSocket connection has been lost");return false}}function ap(aR){w();aM.mdRwdOnWsOpen(aR);ah.mdRwdOnWsOpen(aR)}function U(aR){aM.mdRwdOnWsError(aR);if(!a.isEmptyObject(ah)){ah.mdRwdOnWsError(aR)}}function t(aR){if(aR.code===1006){a("#mdRwdLayoutsBox .mdRwdLoadingBox").hide();a("#mdRwdLayoutChoice").html('<div class="mdRwdWarningMessage">'+aM.html.window.content.warningMessages[aR.code]+"</div>");a("#mdRwdLayoutChoice").show()}aM.mdRwdOnWsClose(aR.code,aR);if(!a.isEmptyObject(ah)){ah.mdRwdOnWsClose(aR.code,aR)}}function aN(aS){var aR=JSON.parse(aS.data);switch(aR.cmd){case"newVc":an(aR);break;case"connVc":ac(aR);break;case"changeLayout":O(aR);break;case"triggerVcEvent":F(aR);break;case"rmVcClient":aD(aR);break;case"rmVc":aj(aR);break;default:break}aM.mdRwdOnWsMessage(aR);ah.mdRwdOnWsMessage(aR)}function w(){var aR="";aR+=e();aR+=A();a("#mdRwdWindowContent").html(aR);if(a("#mdRwdConnectVcId").length){a("#mdRwdConnectVcId").focus()}}function e(){var aR="";if(a.inArray("newVc",ah.connectionTypesArray)>-1){N();aR+='<div id="mdRwdVcCell" '+(ah.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aR+='	<div id="mdRwdVcBox">';aR+='	    <div id="mdRwdVcLabel">'+aM.html.window.content.vcLabel+"</div>";aR+='         <div class="mdRwdLoadingBox">';aR+='             <img src="'+aM.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aR+="         </div>";aR+='	    <div id="mdRwdVcId"></div>';aR+="	</div>";aR+="</div>"}return aR}function A(){var aR="";if(a.inArray("connVc",ah.connectionTypesArray)>-1){aR+='<div id="mdRwdConnectVcCell" '+(ah.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aR+='	<div id="mdRwdConnectVcBox">';aR+='	    <div id="mdRwdConnectVcLabel">'+aM.html.window.content.connectVcLabel+"</div>";aR+='         <div class="mdRwdLoadingBox">';aR+='             <img src="'+aM.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aR+="         </div>";aR+='	    <div id="mdRwdConnectVc"><input type="text" pattern="[0-9]*" id="mdRwdConnectVcId"/><button id="mdRwdConnectVcButton">'+aM.html.window.content.connectVcButton+"</button></div>";aR+="	</div>";aR+="</div>";a(document).off("keydown","#mdRwdConnectVcId");a(document).on("keydown","#mdRwdConnectVcId",function(aS){if(aS.keyCode==13){a("#mdRwdConnectVcButton").trigger("click")}});a(document).off("click touchend","#mdRwdConnectVcButton");a(document).on("click touchend","#mdRwdConnectVcButton",function(){ad=a("#mdRwdConnectVcId").val();S()})}return aR}function N(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();K={cmd:"newVc",vcId:"",client:{device:ar,layout:{id:ah.id}}};if(aM.stateful){K.initComponents={};a.each(aM.components,function(aR,aS){K.initComponents[aR]={};K.initComponents[aR].id=aS.id;K.initComponents[aR].state=aS.state});K.client.layout.components=aM.componentsArray}K.initLayouts={};a.each(aM.layouts,function(aS,aR){K.initLayouts[aS]={};K.initLayouts[aS].id=aR.id;K.initLayouts[aS].maxInstances=aR.maxInstances;K.initLayouts[aS].instances=[]});aa(K)}function S(){a("#mdRwdConnectVc").hide();a("#mdRwdConnectVcBox .mdRwdLoadingBox").show();K={cmd:"connVc",vcId:ad,client:{device:ar,layout:{id:ah.id}}};if(aM.stateful){K.client.layout.components=ah.componentsArray}aa(K)}function ag(aR){if(aM.layouts[aR]){if(aR!=ah.id){if(a.inArray(ar.id,aM.layouts[aR].devicesArray)>-1){var aS=ah;var aT=aM.layouts[aR];ah=aT;K={cmd:"changeLayout",vcId:ad,client:{device:ar,layout:{id:ah.id},oldLayout:{id:aS.id}}};if(aM.stateful){K.client.layout.components=ah.componentsArray}aa(K)}else{D('The layout "'+aR+'"  is not associated with the current "'+ar.id+'" device');return false}}else{D('The layout "'+aR+'" is the current layout');return false}}else{D('The layout "'+aR+'" does not exist');return false}}function an(aS){var aT={namespace:y,timeStamp:aS.timeStamp,type:aS.cmd,eventData:{},client:aS.client,vcId:aS.vcId,vcClients:aS.vcClients,vcLayouts:aS.vcLayouts};a("#mdRwdVcBox .mdRwdLoadingBox").hide();a("#mdRwdVcId").show();ad=aS.vcId;if(h==null&&aS.client.isMe){h=aS.client.id}if(aS.statusCode!=Q){aM.mdRwdOnWarning(aS.statusCode);ah.mdRwdOnWarning(aS.statusCode);var aR="";aR+='<div class="mdRwdWarning">';aR+=' <div class="mdRwdWarningMessage">'+aM.html.window.content.warningMessages[aS.statusCode]+"</div>";aR+=' <div class="mdRwdWarningBackButton">'+aM.html.window.content.warningBackButton+"</div>";aR+="</div>";a("#mdRwdVcId").html(aR);a(document).off("click touchend","#mdRwdVcBox .mdRwdWarningBackButton");a(document).on("click touchend","#mdRwdVcBox .mdRwdWarningBackButton",function(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();var aU="";aU+=e();a("#mdRwdVcCell").replaceWith(aU)})}else{a("#mdRwdVcId").html(ad);ah.events.incoming.mdRwd.newVc(aT,aS)}}function ac(aS){var aT={namespace:y,timeStamp:aS.timeStamp,type:aS.cmd,eventData:{},client:aS.client,vcId:aS.vcId,vcClients:aS.vcClients,vcLayouts:aS.vcLayouts};if(h==null&&aS.client.isMe){h=aS.client.id}if(aS.statusCode!=Q){if(aS.lock){aP=Date.now();if(!Y){Y=true;av=aP}if(aP-av>aM.connVcTimeout){aM.mdRwdOnWarning(aS.statusCode);ah.mdRwdOnWarning(aS.statusCode);Y=false;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aR="";aR+='<div class="mdRwdWarning">';aR+=' <div class="mdRwdWarningMessage">'+aM.html.window.content.warningMessages[aS.statusCode]+"</div>";aR+=' <div class="mdRwdWarningBackButton">'+aM.html.window.content.warningBackButton+"</div>";aR+="</div>";a("#mdRwdConnectVc").html(aR);a(document).off("click touchend","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click touchend","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aU="";aU+=A();a("#mdRwdConnectVcCell").replaceWith(aU);a("#mdRwdConnectVcId").focus()})}else{setTimeout(function(){S()},aM.connVcInterval)}}else{aM.mdRwdOnWarning(aS.statusCode);ah.mdRwdOnWarning(aS.statusCode);a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aR="";aR+='<div class="mdRwdWarning">';aR+=' <div class="mdRwdWarningMessage">'+aM.html.window.content.warningMessages[aS.statusCode]+"</div>";aR+=' <div class="mdRwdWarningBackButton">'+aM.html.window.content.warningBackButton+"</div>";aR+="</div>";a("#mdRwdConnectVc").html(aR);a(document).off("click touchend","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click touchend","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aU="";aU+=A();a("#mdRwdConnectVcCell").replaceWith(aU);a("#mdRwdConnectVcId").focus()})}}else{if(!aw){aw=true;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();if(aM.stateful){if(aS.client.isMe){l(aS.componentsFromServer)}}f.focus();aK();n();ak();z();E(function(){ah.events.incoming.mdRwd.connVc(aT,aS);aM.mdRwdOnMultiDeviceMode();ah.mdRwdOnMultiDeviceMode();aH=ai;if(!aS.client.isMe&&aM.stateful&&aM.autoManageStates){p()}})}else{ah.events.incoming.mdRwd.connVc(aT,aS);if(!aS.client.isMe&&aM.stateful&&aM.autoManageStates){p()}}}}function O(aR){var aS={namespace:y,timeStamp:aR.timeStamp,type:aR.cmd,eventData:{},client:aR.client,vcId:aR.vcId,vcClients:aR.vcClients,vcLayouts:aR.vcLayouts};if(aR.statusCode!=Q){aM.mdRwdOnWarning(aR.statusCode);ah.mdRwdOnWarning(aR.statusCode)}else{if(aR.client.isMe){a("link[href='"+aM.layouts[aR.client.oldLayout.id].css+"']").remove();aO();I();W={};if(aM.stateful){l(aR.componentsFromServer)}aK();n();ak()}ah.events.incoming.mdRwd.changeLayout(aS,aR);if(!aR.client.isMe&&aM.stateful&&aM.autoManageStates){p()}}}function F(aR){var aS={namespace:y,timeStamp:aR.timeStamp,type:aR.event.type,eventData:aR.event.eventData,client:aR.client,vcId:aR.vcId};if(aM.stateful){aS.affectedComponents=aR.event.affectedComponents}R(aS);ah.events.incoming.mdRwd.triggerVcEvent(aS,aR)}function aD(aR){var aS={namespace:y,timeStamp:aR.timeStamp,type:aR.cmd,eventData:{},client:aR.client,vcId:aR.vcId};ah.events.incoming.mdRwd.rmVcClient(aS,aR)}function aj(aR){var aS={namespace:y,timeStamp:aR.timeStamp,type:aR.cmd,eventData:{},client:aR.client,vcId:aR.vcId};ah.events.incoming.mdRwd.rmVc(aS,aR)}function R(aR){a(document).trigger(aR)}function l(aR){if(aR){a.each(aR,function(aS,aT){aM.components[aS].state=a.extend(true,aM.components[aS].state,aT.state)})}}function p(){a.each(ah.componentsArray,function(aS,aR){if(!a.isEmptyObject(aM.components[aR].state)){au(aR)}})}function aq(aR,aS){if(aM.components[aR]){aM.components[aR].state=aS;if(ad!=null){au(aR)}}else{D('The component "'+aR+'" does not exist');return false}}function au(aS){var aR={};aR.id=aM.components[aS].id;aR.state=aM.components[aS].state;K={cmd:"setVcCompState",vcId:ad,componentState:aR,client:{device:ar,layout:{id:ah.id,components:ah.componentsArray}}};aa(K)}function ax(aR){if(aM.components[aR]){return aM.components[aR].state}else{D('The component "'+aR+'" does not exist');return false}}function af(){return h}function T(){return ad}function r(){return ar}function i(){return ah}function u(){return aH}var c={};c={triggerVcEvent:R,changeLayout:ag,destroy:G,getMyId:af,getMyVc:T,getMyDevice:r,getMyLayout:i,getMyAppMode:u};if(aM.stateful&&!aM.autoManageStates){c.setVcCompState=aq;c.getVcCompState=ax}return c}})(jQuery);