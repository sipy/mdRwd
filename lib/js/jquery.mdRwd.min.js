/* 
 * mdRwd -  A framework for development of Web applications 
 *          partitioned in different communicating devices.
 * http://www.mdRwd.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of mdRwd.
 * 
 * mdRwd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * mdRwd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/

;(function(a){a.fn.mdRwd=function(V){var f=a(this);var F="#"+f.attr("id");var r={mdRwd:["newVc","connVc","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var J={ip:"",port:"",debug:false,stateful:false,connVcInterval:500,connVcTimeout:10000,mdRwdOnInit:function(){},mdRwdOnDestroy:function(){},mdRwdOnWindowShow:function(){},mdRwdOnWindowHide:function(){},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aL,aM){},mdRwdOnWarning:function(aL){},mdRwdOnWsOpen:function(aL){},mdRwdOnWsMessage:function(aL){},mdRwdOnWsError:function(aL){},mdRwdOnWsClose:function(aL,aM){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{"1006":"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)","7000":"The virtual channel does not exist","7001":"You are allready conncetd to this virtual channel<br/>Try again","7002":"There is no available virtual channel<br/>Please try again later","7003":"The virtual channel is full<br/>Please try again later","7004":"The virtual channel for current IP is full<br/>Please try again later","7005":"The virtual channel is currently busy<br/>Please try again later","7006":"The virtual channel for current layout is full<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:4096}},components:{},layouts:{}};var aG=a.extend(true,{},J,V);var am={};var w="mdRwd";var aG,d,I,am,ad,S,Z,h,M,w,aq,U,aJ,ap;av();function av(){R();g();aB();ag();m();v();A();}function R(){aG.connectionTypesArray=["newVc","connVc"];aG.componentsArray=Object.keys(aG.components);aG.devicesArray=Object.keys(aG.devices);aG.layoutsArray=Object.keys(aG.layouts);d={};I={};ad={};S={};Z=null;h=null;M=5000;aq=false;U=false;aJ=null;ap=null;}function E(){if(!a.isEmptyObject(d)){d.close();}j();}function j(){A();az();A();if(aq){a("link[href='"+ad.css+"']").remove();aD();aI();G();C(function(){aG.mdRwdOnMonoDeviceMode();ad.mdRwdOnMonoDeviceMode();});}else{C();}R();aG.mdRwdOnDestroy();}function A(){f.html(aG.html.connectButton);a(document).off("click",F);a(document).on("click",F,function(){aG.mdRwdOnInit();aw();au();});}function x(){f.html(aG.html.disconnectButton);a(document).off("click",F);a(document).on("click",F,function(){E();});}function B(aL){E();if(aG.debug){a.error("mdRwd => "+aL);}}function m(){a.each(aG.devices,function(aM,aL){if(aL.minWidth&&aL.maxWidth){if(window.screen.width>=aL.minWidth&&window.screen.width<=aL.maxWidth){am=aL;am.screenWidth=window.screen.width;am.screenHeight=window.screen.height;}}else{B('The device "'+aM+'" must have "minWidh" and "maxWidth" properties');return false;}});}function g(){var aL={id:"",minWidth:0,maxWidth:0};a.each(aG.devices,function(aN,aM){aL.id=aN;aG.devices[aN]=a.extend(true,{},aL,aM);});}function aB(){if(!a.isEmptyObject(aG.components)){var aL={id:"",selector:"",monoDeviceVisible:true};if(aG.stateful){aL.state={};}a.each(aG.components,function(aM,aN){aL.id=aM;aL.monoDeviceVisible=!a(aN.selector).is(":hidden");aG.components[aM]=a.extend(true,{},aL,aN);});}else{B("You must define at least one component");return false;}}function ag(){var aM={};var aL={};a.each(r,function(aP,aO){aM[aP]="";aL[aP]={};if(aO.length>0){a.each(aO,function(aQ,aR){aL[aP][aR]=function(){};});}});var aN={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",maxInstances:-1,events:{outgoing:aM,incoming:aL},mdRwdOnMultiDeviceMode:function(){},mdRwdOnMonoDeviceMode:function(){},mdRwdOnChangeLayout:function(aO,aP){},mdRwdOnWarning:function(aO){},mdRwdOnWsOpen:function(aO){},mdRwdOnWsMessage:function(aO){},mdRwdOnWsError:function(aO){},mdRwdOnWsClose:function(aO,aP){}};if(!a.isEmptyObject(aG.layouts)){a.each(aG.layouts,function(aP,aO){aO.connectionTypesArray=a.map(aO.connectionTypes.split(","),a.trim);a.each(aO.connectionTypesArray,function(aQ,aR){if(a.inArray(aR,aG.connectionTypesArray)==-1){B('The connection type "'+aR+'" of the layout "'+aP+'" does not exist (available connection types: "newVc", "connVc")');return false;}});aO.devicesArray=a.map(aO.devices.split(","),a.trim);a.each(aO.devicesArray,function(aQ,aR){if(a.inArray(aR,aG.devicesArray)==-1){B('The device "'+aR+'" of the layout "'+aP+'" does not exist (available devices: "'+aG.devicesArray.join('", "')+'")');return false;}});aO.componentsArray=a.map(aO.components.split(","),a.trim);a.each(aO.componentsArray,function(aR,aQ){if(a.inArray(aQ,aG.componentsArray)==-1){B('The component "'+aQ+'" of the layout "'+aP+'" does not exist (available components: "'+aG.componentsArray.join('", "')+'")');return false;}});a.each(aO.events.outgoing,function(aR,aQ){aO.events.outgoing[aR+"Obj"]={};var aS={};a.each(aQ.match(/(?:[^,(]|\([^)]*\))+/g),function(aT,aU){aS=aC(aP,aR,aU);aO.events.outgoing[aR+"Obj"][aS.event]={};if(aG.stateful){aO.events.outgoing[aR+"Obj"][aS.event].affectedComponents=aS.affectedComponents;}});});aN.id=aP;aG.layouts[aP]=a.extend(true,{},aN,aO);});}else{B("You must define at least one layout");return false;}}function aE(){a('<link href="'+ad.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");a("body").animate({scrollTop:0},"fast");a.each(aG.components,function(aL,aM){if(a.inArray(aL,ad.componentsArray)>-1){a(aM.selector).show();}else{a(aM.selector).hide();}});}function aD(){a.each(aG.components,function(aL,aM){if(aM.monoDeviceVisible){a(aM.selector).show();}else{a(aM.selector).hide();}});}function v(){var aM="";aM='<div id="mdRwdOverlay"></div>';var aL="";aL+='<div id="mdRwdWindow">';aL+='	<div id="mdRwdWindowHeader">';aL+='	    <div id="mdRwdWindowTitle">'+aG.html.window.header.title+"</div>";aL+='	    <div id="mdRwdWindowClose">'+aG.html.window.header.close+"</div>";aL+="	</div>";aL+='	<div id="mdRwdWindowContent"></div>';aL+='	<img src="'+aG.html.window.content.loadingImgPath+'" style="display:none;"/>';aL+="</div>";a("body").append(aM);a("body").append(aL);}function aw(){if(a("#mdRwdWindow").is(":hidden")){a("#mdRwdWindow").slideDown("fast");a("#mdRwdOverlay").fadeIn("fast").promise().done(function(){aG.mdRwdOnWindowShow();a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).on("click","#mdRwdWindowClose, #mdRwdOverlay",function(){E();});});}}function C(aL){if(!a("#mdRwdOverlay").is(":hidden")){a("#mdRwdOverlay").fadeOut("fast");a("#mdRwdWindow").slideUp("fast").promise().done(function(){aG.mdRwdOnWindowHide();a("#mdRwdVcId").html("");a(".mdRwdWarningMessage").html("");if(aL){aL();}});}else{if(aL){aL();}}}function au(){var aM=[];a.each(aG.layouts,function(aO,aN){if(a.inArray(am.id,aN.devicesArray)>-1){aM.push(aO);}});var aL="";if(aM.length>1){aL+='<div id="mdRwdLayoutsCell">';aL+='	    <div id="mdRwdLayoutsBox">';aL+='             <div class="mdRwdLoadingBox">';aL+='                 <img src="'+aG.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aL+="             </div>";aL+='             <div id="mdRwdLayoutChoice">';aL+='                 <div id="mdRwdLayoutLabel">'+aG.html.window.content.layoutsLabel+"</div>";aL+='                 <div id="mdRwdLayouts">';a.each(aM,function(aO,aN){var aP=aG.layouts[aN];aL+='             <div class="mdRwdLayout mdRwdButton" layoutId="'+aN+'">';aL+='                 <div class="mdRwdLayoutName">'+aP.html.name+"</div>";aL+='                 <div class="mdRwdLayoutDescription">'+aP.html.description+"</div>";aL+="             </div>";});aL+="                 </div>";aL+="		</div>";aL+="	    </div>";aL+="</div>";a("#mdRwdWindowContent").html(aL);a(document).off("click",".mdRwdLayout");a(document).on("click",".mdRwdLayout",function(){ad=aG.layouts[a(this).attr("layoutId")];ah();});}else{if(aM.length==1){aL+='<div id="mdRwdLayoutsCell">';aL+='	    <div id="mdRwdLayoutsBox">';aL+='             <div class="mdRwdLoadingBox">';aL+='                 <img src="'+aG.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aL+="             </div>";aL+='             <div id="mdRwdLayoutChoice">';aL+="             </div>";aL+="         </div>";aL+="</div>";a("#mdRwdWindowContent").html(aL);ad=aG.layouts[aM[0]];ah();}else{B('The "'+am.id+'" device has no associated layouts');return false;}}}function z(aL){return a.trim(aL)+"."+w;}function aC(aM,aO,aP){var aL=aP.match(/\((.*?)\)/g);var aR=[];var aQ=a.trim(aP);var aN={};if(aL){aR=a.trim(aP.match(/\((.*?)\)/g)[0]);aR=aR.slice(1,-1);aQ=a.trim(aP.replace("("+aR+")",""));aR=a.map(aR.split(","),a.trim);a.each(aR,function(aT,aS){if(a.inArray(aS,aG.componentsArray)==-1){B('The affected component "'+aS+'" by the outgoing event "'+aQ+'" of the layout "'+aM+'" does not exist');return false;}});}if(aO!="custom"&&a.inArray(aQ,r[aO])==-1){B('The outgoing event "'+aQ+'" of the layout "'+aM+'" does not exist in the default "'+aO+'" events');return false;}aN.event=aQ;aN.affectedComponents=aR;return aN;}function n(){H();an();X();at();}function af(){t();K();T();aA();}function az(){a(document).off("click","#mdRwdWindowClose, #mdRwdOverlay");a(document).off("click",".mdRwdLayout");a(document).off("keydown","#mdRwdConnectVcId");a(document).off("click","#mdRwdConnectVcButton");a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");}function aI(){b();o();k();p();}function G(){aa();ax();aK();aj();}function aF(aL){I={cmd:"triggerVcEvent",vcId:Z,event:aL,client:{device:am,layout:{id:ad.id}}};if(aG.stateful){I.client.layout.components=ad.componentsArray;}W(I);}function H(){var aL=ad.events.outgoing.keyboard;if(aL){if(aL=="all"){aL=a.map(r.keyboard.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.keyboardObj),z).join(" ");}a(document).on(aL,function(aN){if(!aN.namespace||aN.namespace!=w){var aM={type:aN.type,eventData:{timeStamp:aN.timeStamp,altKey:aN.altKey,shiftKey:aN.shiftKey,ctrlKey:aN.ctrlKey,metaKey:aN.metaKey,charCode:aN.charCode,keyCode:aN.keyCode}};if(aG.stateful){aM.affectedComponents=ad.events.outgoing.keyboardObj[aN.type].lenght>0?ad.events.outgoing.keyboardObj[aN.type].join(", "):"";}aF(aM);}});}}function b(){var aL=ad.events.outgoing.keyboard;if(aL){if(aL=="all"){aL=a.map(r.keyboard.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.keyboardObj),z).join(" ");}a(document).off(aL);}}function t(){if(ad.events.incoming.keyboard){a.each(ad.events.incoming.keyboard,function(aL,aM){a(document).on(z(aL),aM);});}}function aa(){if(ad&&ad.events&&ad.events.incoming&&ad.events.incoming.keyboard){a.each(ad.events.incoming.keyboard,function(aL,aM){a(document).off(z(aL));});}}function an(){var aL=ad.events.outgoing.mouse;if(aL){if(aL=="all"){aL=a.map(r.mouse.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.mouseObj),z).join(" ");}a(document).on(aL,function(aM){if(!aM.namespace||aM.namespace!=w){var aN={type:aM.type,eventData:{timeStamp:aM.timeStamp,altKey:aM.altKey,shiftKey:aM.shiftKey,ctrlKey:aM.ctrlKey,metaKey:aM.metaKey,button:aM.button,center:{pageX:aM.pageX,pageY:aM.pageY},target:aM.target.id}};if(aG.stateful){aN.affectedComponents=ad.events.outgoing.mouseObj[aM.type].affectedComponents.length>0?ad.events.outgoing.mouseObj[aM.type].affectedComponents:[];}aF(aN);}});}}function o(){var aL=ad.events.outgoing.mouse;if(aL){if(aL=="all"){aL=a.map(r.mouse.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.mouseObj),z).join(" ");}a(document).off(aL);}}function K(){if(ad.events.incoming.mouse){a.each(ad.events.incoming.mouse,function(aM,aL){a(document).on(z(aM),aL);});}}function ax(){if(ad&&ad.events&&ad.events.incoming&&ad.events.incoming.mouse){a.each(ad.events.incoming.mouse,function(aM,aL){a(document).off(z(aM));});}}function X(){var aL=ad.events.outgoing.touch;if(aL){if(aL=="all"){aL=a.map(r.touch.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.touchObj),z).join(" ");}a(document).hammer({prevent_default:true}).on(aL,function(aO){if(!aO.namespace||aO.namespace!=w){var aP=[];var aM={};var aN={};if(aO.gesture){if(aO.gesture.startEvent.touches){a.each(aO.gesture.startEvent.touches,function(aQ,aR){aP.push({type:aR.type,eventData:{center:{pageX:aR.pageX,pageY:aR.pageY},parentOffsetX:aR.offsetX,parentOffsetY:aR.offsetY,target:aR.target.id}});});}aN={type:aO.type,eventData:{timeStamp:aO.gesture.startEvent.timeStamp,target:aO.gesture.startEvent.target.id,center:aO.gesture.startEvent.center,pointerType:aO.gesture.startEvent.pointerType,eventType:aO.gesture.startEvent.eventType,srcEventType:aO.gesture.startEvent.srcEvent.type,touches:aP}};if(aO.gesture.touches){aP=[];a.each(aO.gesture.touches,function(aQ,aR){aP.push({type:aR.type,eventData:{center:{pageX:aR.pageX,pageY:aR.pageY},parentOffsetX:aR.offsetX,parentOffsetY:aR.offsetY,target:aR.target.id}});});}aM={type:aO.type,eventData:{timeStamp:aO.gesture.timeStamp,screenDim:{height:a(window).height(),width:a(window).width()},target:aO.gesture.target.id,center:aO.gesture.center,pointerType:aO.gesture.pointerType,deltaTime:aO.gesture.deltaTime,deltaX:aO.gesture.deltaX,deltaY:aO.gesture.deltaY,velocityX:aO.gesture.velocityX,velocityY:aO.gesture.velocityY,angle:aO.gesture.angle,direction:aO.gesture.direction,distance:aO.gesture.distance,scale:aO.gesture.scale,rotation:aO.gesture.rotation,eventStatus:aO.gesture.eventType,srcEventType:aO.gesture.srcEvent.type,startEvent:aN,touches:aP}};if(aG.stateful){aM.affectedComponents=ad.events.outgoing.touchObj[aO.type].affectedComponents.length>0?ad.events.outgoing.touchObj[aO.type].affectedComponents:[];}}aF(aM);}});}}function k(){var aL=ad.events.outgoing.touch;if(aL){if(aL=="all"){aL=a.map(r.touch.join(" "),z);}else{aL=a.map(Object.keys(ad.events.outgoing.touchObj),z).join(" ");}a(document).hammer().off(aL);}}function T(){if(ad.events.incoming.touch){a.each(ad.events.incoming.touch,function(aM,aL){a(document).on(z(aM),aL);});}}function aK(){if(ad&&ad.events&&ad.events.incoming&&ad.events.incoming.touch){a.each(ad.events.incoming.touch,function(aM,aL){a(document).off(z(aM));});}}function at(){var aL=ad.events.outgoing.custom;if(aL){aL=a.map(Object.keys(ad.events.outgoing.customObj),z).join(" ");a(document).on(aL,function(aN){if(!aN.namespace||aN.namespace!=w){var aM={type:aN.type,eventData:aN.eventData?aN.eventData:{}};if(aG.stateful){aM.affectedComponents=ad.events.outgoing.customObj[aN.type].affectedComponents.length>0?ad.events.outgoing.customObj[aN.type].affectedComponents:[];}aF(aM);}});}}function p(){var aL=ad.events.outgoing.custom;if(aL){aL=a.map(Object.keys(ad.events.outgoing.customObj),z).join(" ");a(document).off(aL);}}function aA(){if(ad.events.incoming.custom){a.each(ad.events.incoming.custom,function(aL,aM){a(document).on(z(aL),aM);});}}function aj(){if(ad&&ad.events&&ad.events.incoming&&ad.events.incoming.custom){a.each(ad.events.incoming.custom,function(aL,aM){a(document).off(z(aL));});}}function ah(){if(window.WebSocket){if(a.isEmptyObject(d)){d=new WebSocket("ws://"+aG.ip+":"+aG.port+"/");d.onopen=ak;d.onmessage=aH;d.onerror=Q;d.onclose=s;a("#mdRwdLayoutsBox .mdRwdLoadingBox").show();a("#mdRwdLayoutChoice").hide();}else{B("Waiting for WebSocket connection");return false;}}else{B("The current browser does not support WebSockets");return false;}}function W(aL){aL=JSON.stringify(aL);if(d.readyState===1){d.send(aL);}else{B("WebSocket connection has been lost");return false;}}function ak(aL){u();aG.mdRwdOnWsOpen(aL);ad.mdRwdOnWsOpen(aL);}function Q(aL){aG.mdRwdOnWsError(aL);if(!a.isEmptyObject(ad)){ad.mdRwdOnWsError(aL);}}function s(aL){if(aL.code===1006){a("#mdRwdLayoutsBox .mdRwdLoadingBox").hide();a("#mdRwdLayoutChoice").html('<div class="mdRwdWarningMessage">'+aG.html.window.content.warningMessages[aL.code]+"</div>");a("#mdRwdLayoutChoice").show();}aG.mdRwdOnWsClose(aL.code,aL);if(!a.isEmptyObject(ad)){ad.mdRwdOnWsClose(aL.code,aL);}}function aH(aN){var aL=JSON.parse(aN.data);var aM={namespace:w,timeStamp:aL.timeStamp,type:aL.cmd=="triggerVcEvent"?aL.event.type:aL.cmd,eventData:aL.cmd=="triggerVcEvent"?aL.event.eventData:null,client:aL.client,vcId:aL.vcId,vcClients:aL.vcClients};switch(aL.cmd){case"newVc":ai(aM,aL);break;case"connVc":Y(aM,aL);break;case"triggerVcEvent":D(aM,aL);break;case"rmVcClient":ay(aM,aL);break;case"rmVc":ae(aM,aL);break;default:break;}aG.mdRwdOnWsMessage(aN,aL);ad.mdRwdOnWsMessage(aN,aL);}function u(){var aL="";aL+=e();aL+=y();a("#mdRwdWindowContent").html(aL);if(a("#mdRwdConnectVcId").length){a("#mdRwdConnectVcId").focus();}}function e(){var aL="";if(a.inArray("newVc",ad.connectionTypesArray)>-1){L();aL+='<div id="mdRwdVcCell" '+(ad.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aL+='	<div id="mdRwdVcBox">';aL+='	    <div id="mdRwdVcLabel">'+aG.html.window.content.vcLabel+"</div>";aL+='         <div class="mdRwdLoadingBox">';aL+='             <img src="'+aG.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aL+="         </div>";aL+='	    <div id="mdRwdVcId"></div>';aL+="	</div>";aL+="</div>";}return aL;}function y(){var aL="";if(a.inArray("connVc",ad.connectionTypesArray)>-1){aL+='<div id="mdRwdConnectVcCell" '+(ad.connectionTypesArray.length==1?'class="mdRwdMaxyCell"':"")+">";aL+='	<div id="mdRwdConnectVcBox">';aL+='	    <div id="mdRwdConnectVcLabel">'+aG.html.window.content.connectVcLabel+"</div>";aL+='         <div class="mdRwdLoadingBox">';aL+='             <img src="'+aG.html.window.content.loadingImgPath+'" class="mdRwdLoadingImg"/>';aL+="         </div>";aL+='	    <div id="mdRwdConnectVc"><input type="text" pattern="[0-9]*" id="mdRwdConnectVcId"/><button id="mdRwdConnectVcButton">'+aG.html.window.content.connectVcButton+"</button></div>";aL+="	</div>";aL+="</div>";a(document).off("keydown","#mdRwdConnectVcId");a(document).on("keydown","#mdRwdConnectVcId",function(aM){if(aM.keyCode==13){a("#mdRwdConnectVcButton").trigger("click");}});a(document).off("click","#mdRwdConnectVcButton");a(document).on("click","#mdRwdConnectVcButton",function(){Z=a("#mdRwdConnectVcId").val();O(false);});}return aL;}function L(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();I={cmd:"newVc",vcId:"",client:{device:am,layout:{id:ad.id}}};if(aG.stateful){I.initComponents={};a.each(aG.components,function(aL,aM){I.initComponents[aL]={};I.initComponents[aL].id=aM.id;I.initComponents[aL].state=aM.state;});I.client.layout.components=aG.componentsArray;}I.initLayouts={};a.each(aG.layouts,function(aM,aL){I.initLayouts[aM]={};I.initLayouts[aM].id=aL.id;I.initLayouts[aM].maxInstances=aL.maxInstances;I.initLayouts[aM].count=0;});W(I);}function ai(aN,aM){a("#mdRwdVcBox .mdRwdLoadingBox").hide();a("#mdRwdVcId").show();Z=aM.vcId;if(h==null&&aM.client.isMe){h=aM.client.id;}if(aM.statusCode!=M){aG.mdRwdOnWarning(aM.statusCode);ad.mdRwdOnWarning(aM.statusCode);var aL="";aL+='<div class="mdRwdWarning">';aL+=' <div class="mdRwdWarningMessage">'+aG.html.window.content.warningMessages[aM.statusCode]+"</div>";aL+=' <div class="mdRwdWarningBackButton">'+aG.html.window.content.warningBackButton+"</div>";aL+="</div>";a("#mdRwdVcId").html(aL);a(document).off("click","#mdRwdVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdVcBox .mdRwdWarningBackButton",function(){a("#mdRwdVcId").hide();a("#mdRwdVcBox .mdRwdLoadingBox").show();var aO="";aO+=e();a("#mdRwdVcCell").replaceWith(aO);});}else{a("#mdRwdVcId").html(Z);ad.events.incoming.mdRwd.newVc(aN,aM);}}function O(aM,aL){a("#mdRwdConnectVc").hide();a("#mdRwdConnectVcBox .mdRwdLoadingBox").show();I={cmd:"connVc",vcId:Z,changeLayout:aM,client:{device:am,layout:{id:ad.id}}};if(aM){I.client.oldLayout={id:aL.id};}if(aG.stateful){I.client.layout.components=ad.componentsArray;}W(I);}function Y(aN,aM){if(h==null&&aM.client.isMe){h=aM.client.id;}if(aM.statusCode!=M){if(aM.lock){aJ=Date.now();if(!U){U=true;ap=aJ;}if(aJ-ap>aG.connVcTimeout){aG.mdRwdOnWarning(aM.statusCode);ad.mdRwdOnWarning(aM.statusCode);U=false;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aL="";aL+='<div class="mdRwdWarning">';aL+=' <div class="mdRwdWarningMessage">'+aG.html.window.content.warningMessages[aM.statusCode]+"</div>";aL+=' <div class="mdRwdWarningBackButton">'+aG.html.window.content.warningBackButton+"</div>";aL+="</div>";a("#mdRwdConnectVc").html(aL);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aO="";aO+=y();a("#mdRwdConnectVcCell").replaceWith(aO);a("#mdRwdConnectVcId").focus();});}else{setTimeout(function(){O(false);},aG.connVcInterval);}}else{aG.mdRwdOnWarning(aM.statusCode);ad.mdRwdOnWarning(aM.statusCode);a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();a("#mdRwdConnectVc").show();var aL="";aL+='<div class="mdRwdWarning">';aL+=' <div class="mdRwdWarningMessage">'+aG.html.window.content.warningMessages[aM.statusCode]+"</div>";aL+=' <div class="mdRwdWarningBackButton">'+aG.html.window.content.warningBackButton+"</div>";aL+="</div>";a("#mdRwdConnectVc").html(aL);a(document).off("click","#mdRwdConnectVcBox .mdRwdWarningBackButton");a(document).on("click","#mdRwdConnectVcBox .mdRwdWarningBackButton",function(){var aO="";aO+=y();a("#mdRwdConnectVcCell").replaceWith(aO);a("#mdRwdConnectVcId").focus();});}}else{if(!aq){aq=true;a("#mdRwdConnectVcBox .mdRwdLoadingBox").hide();if(aG.stateful){if(aM.client.isMe){l(aM.componentsFromServer);}}f.focus();aE();n();af();x();C(function(){aG.mdRwdOnMultiDeviceMode();ad.mdRwdOnMultiDeviceMode();ad.events.incoming.mdRwd.connVc(aN,aM);});}else{ad.events.incoming.mdRwd.connVc(aN,aM);}}}function D(aM,aL){N(aM);ad.events.incoming.mdRwd.triggerVcEvent(aM,aL);}function ay(aM,aL){ad.events.incoming.mdRwd.rmVcClient(aM,aL);}function ae(aM,aL){ad.events.incoming.mdRwd.rmVc(aM,aL);}function N(aL){a(document).trigger(aL);}function l(aL){if(aL){a.each(aL,function(aM,aN){al(aM,aN.state,false);});}}function al(aL,aM,aN){if(aG.components[aL]){aG.components[aL].state=aM;aN=typeof aN!=="undefined"?aN:false;if(aN){ao(aL);}}else{B('The component "'+aL+'" does not exist');return false;}}function ao(aM){var aL={};aL.id=aG.components[aM].id;aL.state=aG.components[aM].state;I={cmd:"setVcCompState",vcId:Z,componentState:aL,client:{device:am,layout:{id:ad.id,components:ad.componentsArray}}};W(I);}function ar(aL){if(aG.components[aL]){return aG.components[aL].state;}else{B('The component "'+aL+'" does not exist');return false;}}function ab(){return h;}function P(){return Z;}function q(){return am;}function i(){return ad;}function ac(aL){if(aG.layouts[aL]){if(aL!=ad.id){if(a.inArray(am.id,aG.layouts[aL].devicesArray)>-1){aI();G();var aM=ad;var aN=aG.layouts[aL];S={};aG.mdRwdOnChangeLayout(aM,aN);ad.mdRwdOnChangeLayout(aM,aN);ad=aN;aq=false;U=false;O(true,aM);}else{B('The layout "'+aL+'"  is not associated with the current "'+am.id+'" device');return false;}}else{B('The layout "'+aL+'" is the current layout');return false;}}else{B('The layout "'+aL+'" does not exist');return false;}}var c={};c={triggerVcEvent:N,changeLayout:ac,destroy:E,getMyId:ab,getMyVc:P,getMyDevice:q,getMyLayout:i};if(aG.stateful){c.setVcCompState=al;c.getVcCompState=ar;}return c;};})(jQuery);